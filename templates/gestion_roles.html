{% extends "base.html" %}
{% block title %}Gestion des rÃ´les{% endblock %}
{% block content %}
{% set selected_email = request.args.get('email', '') %}

<h2>ğŸ” Gestion des rÃ´les utilisateurs</h2>

<a href="{{ url_for('admin.gestion_utilisateurs') }}" class="btn btn-outline-secondary mb-3">
    â¬…ï¸ Retour Ã  la gestion des utilisateurs
</a>

{% if doublon %}
<div class="alert alert-warning">
    âš ï¸ Ce rÃ´le est dÃ©jÃ  attribuÃ© Ã  cet utilisateur.
</div>
{% endif %}

<form method="post" class="mb-4">
    <input type="hidden" name="action" value="ajouter">
    <div class="row g-2 align-items-end">
        <div class="col-md-4">
            <label>Email utilisateur :</label>
            <select name="user_email" class="form-select" required>
                <option value="">-- Choisir un utilisateur --</option>
                {% for email in users %}
                    <option value="{{ email }}" {% if email == selected_email %}selected{% endif %}>{{ email }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label>Application :</label>
            <select name="appli" class="form-select">
                <option value="benevoles">BÃ©nÃ©voles</option>
                <option value="associations">Associations</option>
                <option value="distribution">Distribution</option>
                <option value="fournisseurs">Fournisseurs</option>
                <option value="evenements">Ã‰vÃ©nements</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Droit :</label>
            <select name="droit" class="form-select">
                <option value="aucun">Aucun</option>
                <option value="lecture">Lecture seule</option>
                <option value="ecriture">Ã‰criture</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">â• Ajouter</button>
        </div>
    </div>
</form>

<!-- === TABLEAU === -->
<table id="rolesTable" class="table table-striped table-bordered align-middle" style="width:100%">
    <thead class="table-light">
        <tr>
            <th>Email</th>
            <th>Application</th>
            <th>Droit</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for role in roles %}
            {% if not request.args.get("email") or role.user_email == request.args.get("email") %}
            <tr>
                <td>{{ role.user_email }}</td>
                <td>{{ role.appli }}</td>
                <td>{{ role.droit }}</td>
                <td>
                    <form method="post" style="display:inline;">
                        <input type="hidden" name="action" value="supprimer_{{ role.id }}">
                        <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Supprimer</button>
                    </form>
                </td>
            </tr>
            {% endif %}
        {% endfor %}
    </tbody>
</table>

<!-- âœ… DataTables version stable + Buttons + Bootstrap 5 -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<!-- Extensions Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
$(document).ready(function () {
    $('#rolesTable').DataTable({
        order: [[0, 'asc']],
        pageLength: 10,
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json'
        },
        dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center mt-2"ip>',
        buttons: [
            { extend: 'excelHtml5', text: 'ğŸ“Š Export Excel', className: 'btn btn-success btn-sm' },
            { extend: 'csvHtml5', text: 'ğŸ“„ Export CSV', className: 'btn btn-outline-secondary btn-sm' },
            { extend: 'pdfHtml5', text: 'ğŸ“• Export PDF', className: 'btn btn-outline-danger btn-sm' },
            { extend: 'copyHtml5', text: 'ğŸ“‹ Copier', className: 'btn btn-outline-primary btn-sm' }
        ]
    });
});
</script>

{% endblock %}
