{% extends "base.html" %}
{% block title %}Gestion des utilisateurs{% endblock %}


{% block content %}
<h2 class="mb-4">üë• Gestion des utilisateurs</h2>

<form method="post" action="{{ url_for('admin.update_users_batch') }}">

    <input type="text"
       id="userFilter"
       class="form-control mb-3"
       placeholder="üîç Filtrer par email, nom ou r√¥le...">


<table class="table table-bordered table-sm" id="usersTable">
    <thead>
        <tr>
            <th>Id</th>
            <th>Email</th>
            <th>Nom</th>
            <th>R√¥le (UI)</th>
            <th>Actif</th>
            <th>Nouveau mot de passe</th>
            <th>Droits</th>
        </tr>
    </thead>

    <tbody>
    {% for user in users %}
        <tr>
            <td>
                <input class="form-control text-center"
                    style="width: 6ch;"
                    name="id[{{ loop.index0 }}][username]"
                    value="{{ user.id }}">            </td>
            <td>
                <input type="hidden"
                    name="users[{{ loop.index0 }}][id]"
                    value="{{ user.id }}">
                <input class="form-control" value="{{ user.email }}" disabled>
            </td>

            <td>
                <input class="form-control"
                       name="users[{{ loop.index0 }}][username]"
                       value="{{ user.username }}">
            </td>

            <td>
                <select class="form-select"
                        name="users[{{ loop.index0 }}][role]">
                    <option value="user" {% if user.role == "user" %}selected{% endif %}>Utilisateur</option>
                    <option value="gestionnaire" {% if user.role == "gestionnaire" %}selected{% endif %}>Gestionnaire</option>
                    <option value="car" {% if user.role == "car" %}selected{% endif %}>CAR</option>
                    <option value="admin" {% if user.role == "admin" %}selected{% endif %}>Admin</option>
                </select>
            </td>

            <td>
                <select class="form-select"
                        name="users[{{ loop.index0 }}][actif]">
                    <option value="Oui" {% if user.actif %}selected{% endif %}>Oui</option>
                    <option value="Non" {% if not user.actif %}selected{% endif %}>Non</option>
                </select>
            </td>
            <td>
                <input type="password"
                    name="users[{{ loop.index0 }}][new_password]"
                    class="form-control"
                    placeholder="Laisser vide si inchang√©">
            </td>

            <td>
                {% if user.resume_roles %}
                    <ul class="mb-0">
                    {% for role in user.resume_roles %}
                        <li>
                            <strong>{{ role.label }}</strong>
                            <span class="badge
                                {% if role.droit == 'lecture' %}bg-info
                                {% elif role.droit == 'ecriture' %}bg-warning
                                {% elif role.droit == 'admin' %}bg-danger
                                {% else %}bg-secondary{% endif %}
                            ">
                                {{ role.droit }}
                            </span>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    ‚Äî
                {% endif %}
            </td>

            <td>
                <a href="{{ url_for('admin.gestion_roles_matrice', email=user.email) }}"
                   class="btn btn-secondary btn-sm">
                    ‚öôÔ∏è Droits
                </a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<div class="d-flex gap-2 mt-3">
    <button type="submit" class="btn btn-primary">
        üíæ Enregistrer les modifications
    </button>

    <a href="{{ url_for('index') }}" class="btn btn-secondary">
        ‚¨ÖÔ∏è Retour
    </a>
</div>

</form>

<hr class="my-4">

<!-- ============================= -->
<!-- AJOUT D'UN UTILISATEUR -->
<!-- ============================= -->

<h4>‚ûï Ajouter un utilisateur</h4>

<form method="post" action="{{ url_for('admin.ajouter_utilisateur') }}" class="mt-3">

    <div class="row mb-2">
        <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email"
                   name="email"
                   class="form-control"
                   required
                   pattern="^[a-zA-Z0-9._%+-]+@banquealimentaire\.org$"
                   title="L'email doit se terminer par @banquealimentaire.org">
        </div>

        <div class="col-md-4">
            <label class="form-label">Nom</label>
            <input type="text"
                   name="username"
                   class="form-control">
        </div>

        <div class="col-md-4">
            <label class="form-label">R√¥le (UI)</label>
            <select name="role" class="form-select">
                <option value="user">Utilisateur</option>
                <option value="gestionnaire">Gestionnaire</option>
                <option value="admin">Administrateur</option>
            </select>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">Mot de passe</label>
            <input type="password"
                   name="password"
                   class="form-control"
                   required>
        </div>

        <div class="col-md-4">
            <label class="form-label">Actif</label>
            <select name="actif" class="form-select">
                <option value="Oui">Oui</option>
                <option value="Non">Non</option>
            </select>
        </div>
    </div>

    <button type="submit" class="btn btn-success">
        ‚ûï Ajouter l'utilisateur
    </button>
</form>

<a href="{{ url_for('index') }}" class="btn btn-secondary mt-4">
    ‚¨ÖÔ∏è Retour
</a>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const filterInput = document.getElementById("userFilter");
    const rows = document.querySelectorAll("#usersTable tbody tr");

    filterInput.addEventListener("input", function () {
        const filter = filterInput.value.toLowerCase();

        rows.forEach(row => {
            let text = "";

            // Email (input disabled)
            const emailInput = row.querySelector("td input[disabled]");
            if (emailInput) text += " " + emailInput.value;

            // Nom
            const nameInput = row.querySelector("input[name*='[username]']");
            if (nameInput) text += " " + nameInput.value;

            // R√¥le
            const roleSelect = row.querySelector("select[name*='[role]']");
            if (roleSelect) text += " " + roleSelect.value;

            // Droits (texte visible)
            const droitsCell = row.querySelector("td ul");
            if (droitsCell) text += " " + droitsCell.innerText;

            // Comparaison
            row.style.display = text.toLowerCase().includes(filter) ? "" : "none";
        });
    });
});
</script>

{% endblock %}
