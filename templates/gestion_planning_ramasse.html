{% extends "base_bene.html" %}
{% block title %}Gestion Planning Ramasse{% endblock %}

{% block content %}

<form id="planningForm" method="post">

{# ============================== #
#  ğŸ” Bandeau supÃ©rieur : titre + boutons
# ============================== #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Gestion du planning ramasse</h2>
<!-- 
  <div class="form-check mb-2">
    <input class="form-check-input"
          type="checkbox"
          name="impression_partielle"
          id="impression_partielle"
          checked>
    <label class="form-check-label" for="impression_partielle">
      Impression partielle (sans responsables, tri et camion)
    </label>
  </div> -->

  <div class="d-flex gap-2">
    {# ğŸ’¾ Enregistrer #}
    <button type="submit"
            name="action"
            value="enregistrer"
            class="btn btn-primary save-btn"
            disabled>
      ğŸ’¾ Enregistrer le planning
    </button>

    {# â¬…ï¸ Retour Ã  la crÃ©ation #}
    <a href="{{ url_for('planning.creation_planning_ramasse', semaine=semaine) }}"
       class="btn btn-outline-primary">
      â¬…ï¸ Retour Ã  la crÃ©ation
    </a>

    {# ğŸ  Menu planning #}
    <a href="{{ url_for('planning.planning_main') }}"
       class="btn btn-outline-secondary">
      ğŸ  Menu Planning
    </a>

    {# ğŸ–¨ï¸ AperÃ§u #}
    <a id="apercu-link"
       href="{{ url_for('planning.apercu_planning_ramasse', semaine=semaine) }}"
       target="_blank"
       class="btn btn-outline-secondary">
      ğŸ–¨ï¸ AperÃ§u imprimable (A3)
    </a>
  </div>
</div>

{# âš ï¸ Indicateur modifications non enregistrÃ©es #}
<div id="unsaved-warning"
     class="alert alert-warning py-2 px-3 mb-3"
     style="display:none;">
  âš ï¸ Modifications non enregistrÃ©es
</div>


{# ============================== #
#  ğŸ§¾ Formulaire principal de gestion du planning
# ============================== #}
  <div class="gestion-planning-container">
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th class="col-jour">Jour</th>
          <th class="col-semaine">Semaine</th>
          <th class="col-tournee">TournÃ©e</th>
          <th>Chauffeur</th>
          <th>Ã‰quipier</th>
          <th>Responsable Tri</th>
          <th>Membre Tri 1</th>
          <th>Membre Tri 2</th>
          <th>Membre Tri 3</th>
          <th class="col-camion">Camion</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        {# ===================================== #
          Boucle sur toutes les lignes existantes du planning
          Chaque ligne correspond Ã  un jour et une tournÃ©e
        # ===================================== #}
        {% for ligne in lignes %}
        <tr class="jour-{{ ligne.jour|lower }}">
          <td>{{ ligne.jour|capitalize }}</td>
          <td>{{ ligne.semaine }}</td>
          <td><input type="text" value="{{ ligne.tournee_display }}" class="form-control" readonly></td>

          {# Chauffeur / Ã‰quipier / Responsable Tri â€” mÃªme logique rÃ©pÃ©tÃ©e #}
          {% for role, collection, field, remp_field in [
              ('chauffeur', chauffeurs, 'chauffeur_id', 'remplacant_chauffeur_id'),
              ('equipier', equipiers, 'equipier_id', 'remplacant_equipier_id'),
              ('responsable', responsables, 'responsable_id', 'remplacant_responsable_id')
          ] %}
          <td class="{% if ligne[remp_field] %}remplacant-cell{% elif ligne[role+'_absent'] and ligne[field] %}absent-cell{% endif %}">
            {% set actif_id = ligne[remp_field] if ligne[remp_field] else ligne[field] %}
            <select name="{{ role }}_ids[]" class="form-control bene-select" data-role="{{ role }}">
              <option value="" {% if actif_id is none %}selected{% endif %}>-- Aucun --</option>
              <option value="__add__">â• Ajouter un bÃ©nÃ©voleâ€¦</option>
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

              {# BÃ©nÃ©voles priorisÃ©s (ramasse = oui) #}
              {% set ramasse_field = 'ramasse_' + role if role != 'responsable' else 'ramasse_responsable_tri' %}
              {% for bene in collection if bene[ramasse_field]|lower == 'oui' %}
                <option value="{{ bene.id }}"
                        title="ğŸ“ {{ bene.telephone_portable or 'N/A' }} | âœ‰ï¸ {{ bene.email or 'N/A' }}"
                        {% if bene.id == actif_id %}selected{% endif %}
                        {% if ligne[remp_field] and bene.id == ligne[remp_field] %}
                          style="background-color:#d4edda;color:#155724;"
                        {% elif ligne[role+'_absent'] and bene.id == ligne[field] %}
                          style="color:gray;"
                        {% elif bene.id in collections_du_jour[role][ligne.jour|lower]|default([]) and bene.id != actif_id %}
                          style="color:orange;"
                        {% endif %}>
                  âœ… {{ bene.nom }} {{ bene.prenom }}
                  {% if ligne[remp_field] and bene.id == ligne[remp_field] %}
                    (remplaÃ§ant)
                  {% elif ligne[role+'_absent'] and bene.id == ligne[field] %}
                    (absent)
                  {% elif bene.id in collections_du_jour[role][ligne.jour|lower]|default([]) and bene.id != actif_id %}
                    (dÃ©jÃ  affectÃ©)
                  {% endif %}
                </option>
              {% endfor %}

              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

              {# Autres bÃ©nÃ©voles (ramasse = non) #}
              {% for bene in collection if bene[ramasse_field]|lower != 'oui' %}
                <option value="{{ bene.id }}"
                        title="ğŸ“ {{ bene.telephone_portable or 'N/A' }} | âœ‰ï¸ {{ bene.email or 'N/A' }}"
                        {% if bene.id == actif_id %}selected{% endif %}
                        {% if ligne[remp_field] and bene.id == ligne[remp_field] %}
                          style="background-color:#d4edda;color:#155724;"
                        {% elif ligne[role+'_absent'] and bene.id == ligne[field] %}
                          style="color:gray;"
                        {% elif bene.id in collections_du_jour[role][ligne.jour|lower]|default([]) and bene.id != actif_id %}
                          style="color:orange;"
                        {% endif %}>
                  {{ bene.nom }} {{ bene.prenom }}
                  {% if ligne[remp_field] and bene.id == ligne[remp_field] %}
                    (remplaÃ§ant)
                  {% elif ligne[role+'_absent'] and bene.id == ligne[field] %}
                    (absent)
                  {% elif bene.id in collections_du_jour[role][ligne.jour|lower]|default([]) and bene.id != actif_id %}
                    (dÃ©jÃ  affectÃ©)
                  {% endif %}
                </option>
              {% endfor %}
            </select>
          </td>
          {% endfor %}

          {# ======================== #
            Membres Tri (1, 2, 3)
          # ======================== #}
          {% for i in range(1, 4) %}
          <td class="{% if ligne['remplacant_ramasse_tri' ~ i ~ '_id'] %}remplacant-cell{% elif ligne['ramasse_tri' ~ i ~ '_absent'] and ligne['ramasse_tri' ~ i ~ '_id'] %}absent-cell{% endif %}">
            {% set actif_tri_id = ligne['remplacant_ramasse_tri' ~ i ~ '_id'] if ligne['remplacant_ramasse_tri' ~ i ~ '_id'] else ligne['ramasse_tri' ~ i ~ '_id'] %}
            <select name="tri{{ i }}_ids[]" class="form-control bene-select" data-role="tri_externe">
              <option value="" {% if actif_tri_id is none %}selected{% endif %}>-- Aucun --</option>
              <option value="__add__">â• Ajouter un bÃ©nÃ©voleâ€¦</option>
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

              {# BÃ©nÃ©voles "tri externe" (ramasse_tri_externe = oui) #}
              {% for bene in equipiers if bene.ramasse_tri_externe|lower == 'oui' %}
                <option value="{{ bene.id }}"
                        title="ğŸ“ {{ bene.telephone_portable or 'N/A' }} | âœ‰ï¸ {{ bene.email or 'N/A' }}"
                        {% if bene.id == actif_tri_id %}selected{% endif %}
                        {% if ligne['remplacant_ramasse_tri' ~ i ~ '_id'] and bene.id == ligne['remplacant_ramasse_tri' ~ i ~ '_id'] %}
                          style="background-color:#d4edda;color:#155724;"
                        {% elif ligne['ramasse_tri' ~ i ~ '_absent'] and bene.id == ligne['ramasse_tri' ~ i ~ '_id'] %}
                          style="color:gray;"
                        {% endif %}>
                  âœ… {{ bene.nom }} {{ bene.prenom }}
                  {% if ligne['remplacant_ramasse_tri' ~ i ~ '_id'] and bene.id == ligne['remplacant_ramasse_tri' ~ i ~ '_id'] %}
                    (remplaÃ§ant)
                  {% elif ligne['ramasse_tri' ~ i ~ '_absent'] and bene.id == ligne['ramasse_tri' ~ i ~ '_id'] %}
                    (absent)
                  {% endif %}
                </option>
              {% endfor %}

              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

              {# Autres bÃ©nÃ©voles #}
              {% for bene in equipiers if bene.ramasse_tri_externe|lower != 'oui' %}
                <option value="{{ bene.id }}"
                        title="ğŸ“ {{ bene.telephone_portable or 'N/A' }} | âœ‰ï¸ {{ bene.email or 'N/A' }}"
                        {% if bene.id == actif_tri_id %}selected{% endif %}
                        {% if ligne['remplacant_ramasse_tri' ~ i ~ '_id'] and bene.id == ligne['remplacant_ramasse_tri' ~ i ~ '_id'] %}
                          style="background-color:#d4edda;color:#155724;"
                        {% elif ligne['ramasse_tri' ~ i ~ '_absent'] and bene.id == ligne['ramasse_tri' ~ i ~ '_id'] %}
                          style="color:gray;"
                        {% endif %}>
                  {{ bene.nom }} {{ bene.prenom }}
                  {% if ligne['remplacant_ramasse_tri' ~ i ~ '_id'] and bene.id == ligne['remplacant_ramasse_tri' ~ i ~ '_id'] %}
                    (remplaÃ§ant)
                  {% elif ligne['ramasse_tri' ~ i ~ '_absent'] and bene.id == ligne['ramasse_tri' ~ i ~ '_id'] %}
                    (absent)
                  {% endif %}
                </option>
              {% endfor %}
            </select>
          </td>
          {% endfor %}

          {# SÃ©lecteur de camion #}
          <td>
            <select name="camion_ids[]" class="form-control">
              <option value="" {% if ligne.camion_id is none %}selected{% endif %}>-- Aucun --</option>
              {% for camion in camions %}
                <option value="{{ camion.id }}" {% if camion.id == ligne.camion_id %}selected{% endif %}>
                  {{ camion.nom }} ({{ camion.immat }})
                </option>
              {% endfor %}
            </select>
          </td>

          {# Bouton suppression ligne #}
          <td>
            <button type="submit" name="action" value="supprimer_{{ ligne.id }}" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
          </td>

          <input type="hidden" name="ligne_ids[]" value="{{ ligne.id }}">
        </tr>
        {% endfor %}

        {# ============================ #
          Ligne dâ€™ajout dâ€™un nouvel enregistrement
        # ============================ #}
        <tr>
          <td>
            <select name="new_jour" class="form-control">
              <option value="">-- Jour --</option>
              <option value="lundi">Lundi</option>
              <option value="mardi">Mardi</option>
              <option value="mercredi">Mercredi</option>
              <option value="jeudi">Jeudi</option>
              <option value="vendredi">Vendredi</option>
            </select>
          </td>
          <td><input type="number" name="new_semaine" class="form-control" min="1" max="53"></td>
          <td><input type="text" name="new_tournee" class="form-control" placeholder="Nom TournÃ©e"></td>

          {# SÃ©lecteurs pour chauffeur / Ã©quipier / responsable / tri1-3 / camion #}
          {% for champ, liste, role in [
              ('new_chauffeur', chauffeurs, 'chauffeur'),
              ('new_equipier', equipiers, 'equipier'),
              ('new_responsable', responsables, 'responsable'),
              ('new_ramasse_tri1', equipiers, 'tri_externe'),
              ('new_ramasse_tri2', equipiers, 'tri_externe'),
              ('new_ramasse_tri3', equipiers, 'tri_externe')
          ] %}
          <td>
            <select name="{{ champ }}" class="form-control bene-select" data-role="{{ role }}">
              <option value="">-- Aucun --</option>
              <option value="__add__">â• Ajouter un bÃ©nÃ©voleâ€¦</option>
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
              {% for bene in liste %}
                <option value="{{ bene.id }}">{{ bene.nom }} {{ bene.prenom }}</option>
              {% endfor %}
            </select>
          </td>
          {% endfor %}

          <td>
            <select name="new_camion" class="form-control">
              <option value="">-- Aucun --</option>
              {% for camion in camions %}
                <option value="{{ camion.id }}">{{ camion.nom }} ({{ camion.immat }})</option>
              {% endfor %}
            </select>
          </td>

          <td>
            <button type="submit" name="action" value="ajouter" class="btn btn-success btn-sm">â•</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

{# ============================== #
#  ğŸ”š Bandeau infÃ©rieur : boutons identiques au haut
# ============================== #}
<div class="d-flex justify-content-end gap-2 mt-4">
  <button type="submit"
          name="action"
          value="enregistrer"
          class="btn btn-primary save-btn"
          disabled>
    ğŸ’¾ Enregistrer le planning
  </button>

  <a href="{{ url_for('planning.creation_planning_ramasse', semaine=semaine) }}"
     class="btn btn-outline-primary">
    â¬…ï¸ Retour Ã  la crÃ©ation
  </a>

  <a href="{{ url_for('planning.planning_main') }}"
     class="btn btn-outline-secondary">
    ğŸ  Menu Planning
  </a>

  <a href="{{ url_for('planning.apercu_planning_ramasse', semaine=semaine) }}"
     target="_blank"
     class="btn btn-outline-secondary">
    ğŸ–¨ï¸ AperÃ§u imprimable (A3)
  </a>
</div>
</form>


{# ============================== #
  ğŸ”§ Modale + JavaScript commun
# ============================== #}
{% include "partials/quick_benevole_modal.html" %}

<!-- {# âš ï¸ Bootstrap DOIT Ãªtre chargÃ© AVANT ce script (normalement dans base_bene.html) #}
<script src="{{ url_for('static', filename='js/quick_benevole.js') }}?v=2"></script> -->

<script>
document.addEventListener("DOMContentLoaded", function () {
  let isDirty = false;

  const saveButtons = document.querySelectorAll(".save-btn");
  const warning = document.getElementById("unsaved-warning");
  const form = document.querySelector("form");

  function markDirty(e) {
    const target = e.target;

    // ğŸš« NE PAS marquer dirty quand on clique sur "â• Ajouter un bÃ©nÃ©voleâ€¦"
    if (
      target &&
      target.tagName === "SELECT" &&
      target.classList.contains("bene-select") &&
      target.value === "__add__"
    ) {
      return;
    }

    if (isDirty) return;
    isDirty = true;

    saveButtons.forEach(btn => btn.disabled = false);
    if (warning) warning.style.display = "block";
  }

  // ğŸ” Ã‰coute unique sur le form (Ã©vite les doublons)
  if (form) {
    form.addEventListener("change", markDirty);

    form.addEventListener("submit", function () {
      isDirty = false;
      window.removeEventListener("beforeunload", beforeUnloadHandler);
    });
  }

  function beforeUnloadHandler(e) {
    if (!isDirty) return;
    e.preventDefault();
    e.returnValue = "";
  }

  window.addEventListener("beforeunload", beforeUnloadHandler);
});
</script>


{% endblock %}
