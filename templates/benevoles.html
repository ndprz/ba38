{% extends "base_bene.html" %}

{% block title %}Liste des B√©n√©voles{% endblock %}

{% block content %}

<h2>Liste des B√©n√©voles</h2>

<div class="mb-3" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">

    {% if not lecture_seule %}
    <a href="{{ url_for('benevoles.create_benevole') }}" class="btn btn-success">
        ‚ûï Ajouter un nouveau b√©n√©vole
    </a>
    {% else %}
    <button class="btn btn-success" disabled>
        ‚ûï Ajouter un nouveau b√©n√©vole
    </button>
    {% endif %}

    {% if has_access("benevoles", "ecriture") %}
    <button type="button" class="btn btn-success" onclick="updatePublipostageFile()">
        üìÑ Fichiers Publipostage
    </button>
    {% endif %}

    {% if not lecture_seule %}
    <form method="GET" action="{{ url_for('benevoles.edition_tableau_benevoles') }}" style="display:inline;">
        {% for col in selected_columns %}
            <input type="hidden" name="columns" value="{{ col }}">
        {% endfor %}
        {% for grp in selected_groups %}
            <input type="hidden" name="selected_groups" value="{{ grp }}">
        {% endfor %}
        <input type="hidden" name="has_interacted" value="1">
        <button type="submit" class="btn btn-warning">üìù Mise √† jour en tableau</button>
    </form>
    {% else %}
    <button class="btn btn-warning" disabled>üìù Mise √† jour en tableau</button>
    {% endif %}

    <a href="{{ url_for('benevoles.benevoles_archives') }}" class="btn btn-outline-secondary">
        üëÅ Voir les d√©sactiv√©s
    </a>

    <a href="{{ url_for('mail_bene.envoi_mail_benevoles') }}" class="btn btn-outline-primary">
        üìß Mail group√© b√©n√©voles
    </a>

    <button type="button" class="btn btn-outline-danger"
            onclick="resetFilters()">
        ‚ôªÔ∏è R√©initialiser les filtres
    </button>


    <!-- üîÑ Bouton Actualiser (soumet form-options) -->
    <button type="button" class="btn btn-secondary"
            onclick="document.getElementById('form-options').submit();">
        üîÑ Actualiser
    </button>
</div>

<form method="GET" id="form-options">
    <fieldset>
        <legend>Options d'affichage</legend>
        <input type="hidden" name="has_interacted" value="1">
        <input type="hidden" id="selected_groups" name="selected_groups" value="{{ selected_groups|join(',') }}">

        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start;">
            {% for group_name, fields in grouped_fields.items() %}
            {% set safe_group_name = group_name|replace(' ', '_')|lower %}
            <div class="fields-group" style="flex: 1; min-width: 220px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="titre-depliable" onclick="toggleGroup('{{ safe_group_name }}', this)">
                        <span class="chevron">‚û§</span> {{ group_name }}
                    </div>

                    <label style="margin: 0;">
                        <input type="checkbox" class="toggle-master-checkbox" id="toggle-{{ safe_group_name }}"
                            name="selected_groups"
                            value="{{ group_name }}"
                            onclick="toggleAll('{{ safe_group_name }}', this.checked); saveDisplayOptions();"
                            {% if group_name in selected_groups %}checked{% endif %}>
                        Tout s√©lectionner
                    </label>
                </div>
                <div class="fields-container" id="container-{{ safe_group_name }}">
                    {% for field in fields %}
                    {% if field.field_name not in ['id', 'nom'] %}
                    <label>
                        <input type="checkbox"
                            class="field-{{ safe_group_name }} green-checkbox"
                            name="columns"
                            value="{{ field.field_name }}"
                            {% if field.field_name in selected_columns %}checked{% endif %}
                            onchange="updateGroupCheckboxState('{{ safe_group_name }}'); saveDisplayOptions();">
                        {{ field.field_name | format_label }}
                    </label><br>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

            <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
                <input type="text" id="filtre-benevole" class="form-control"
                    placeholder="üîç Rechercher un b√©n√©vole...">
            </div>
        </fieldset>
    </form>
    <hr>

{% if benevoles %}
<div id="scroll-top" style="overflow-x: auto; height: 20px; margin-bottom: 5px;">
    <div id="sync-scroll" style="height: 1px;"></div>
</div>

<div id="scroll-bottom" style="overflow-x: auto; white-space: nowrap;">
    <table class="table table-striped table-bordered table-sticky" id="benevole-table">
        <thead>
            <tr>
                <th class="sticky-col sticky-col-1">Action</th>
                <th class="sticky-col sticky-col-2 sortable" data-sort="id">
                    ID <span class="arrow">‚ñ≤‚ñº</span>
                </th>
                <th class="sticky-col sticky-col-3 sortable" data-sort="nom">
                    Nom <span class="arrow">‚ñ≤‚ñº</span>
                </th>
                {% for column in selected_columns %}
                <th>{{ column | format_label }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in benevoles %}
            <tr>
                <td class="sticky-col sticky-col-1">
                    {% if row['id'] %}
                    <form method="GET" action="{{ url_for('benevoles.update_benevole', benevole_id=row['id']) }}" style="display:inline;">
                        <input type="hidden" name="has_interacted" value="1">
                        <button type="submit" class="btn btn-primary btn-sm">Modifier</button>
                    </form>
                    <a href="{{ url_for('benevoles.desactiver_benevole', benevole_id=row['id']) }}"
                    class="btn btn-sm btn-outline-warning" title="Archiver ce b√©n√©vole">
                    üí§ D√©sactiver
                    </a>
                    {% else %}
                    <span class="text-muted">ID manquant</span>
                    {% endif %}
                </td>
                <td class="sticky-col sticky-col-2">{{ row['id'] }}</td>
                <td class="sticky-col sticky-col-3">
                    {% if row['id'] in photo_ids %}
                    <span class="photo-hover-container" data-img="{{ url_for('static', filename='photos_benevoles/' ~ row['id'] ~ '.jpg') }}">
                    {% else %}
                    <span>
                    {% endif %}
                        {{ row['nom'] }}
                    </span>
                </td>
                {% for column in selected_columns %}
                <td {% if column == 'user_modif' %}class="col-user-modif"{% endif %}>
                {% if row[column] %}
                    {% if column.lower().startswith('tel') or 't√©l√©phone' in column.lower() %}
                    {{ row[column] | format_tel }}
                    {% else %}
                    {{ row[column] }}
                    {% endif %}
                {% else %}
                    -
                {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>Aucun b√©n√©vole trouv√©.</p>
{% endif %}

<script>

const OPTIONS_KEY = "benevoles_display_options";

function saveDisplayOptions() {

    const selectedColumns = Array.from(
        document.querySelectorAll("input[name='columns']:checked")
    ).map(cb => cb.value);

    const selectedGroups = Array.from(
        document.querySelectorAll("input[name='selected_groups']:checked")
    ).map(cb => cb.value);

    localStorage.setItem(OPTIONS_KEY, JSON.stringify({
        columns: selectedColumns,
        groups: selectedGroups
    }));
}


function toggleGroup(groupName, titreElement) {
  const container = document.getElementById(`container-${groupName}`);
  if (container) container.classList.toggle('expanded');
  const chevron = titreElement.querySelector('.chevron');
  if (chevron) {
    chevron.textContent = container.classList.contains('expanded') ? '‚ñº' : '‚û§';
  }
}

function toggleAll(group, checked) {
    document.querySelectorAll('.field-' + group).forEach(cb => cb.checked = checked);

    const master = document.getElementById('toggle-' + group);
    if (master) {
        master.indeterminate = false;
        master.checked = checked;
    }

    updateGroupCheckboxState(group);
}

function updateGroupCheckboxState(group) {

    const boxes = document.querySelectorAll('.field-' + group);
    const master = document.getElementById('toggle-' + group);

    if (!master || boxes.length === 0) return;

    const total = boxes.length;
    const checkedCount = Array.from(boxes).filter(cb => cb.checked).length;

    if (checkedCount === 0) {
        master.checked = false;
        master.indeterminate = false;
    }
    else if (checkedCount === total) {
        master.checked = true;
        master.indeterminate = false;
    }
    else {
        master.checked = false;
        master.indeterminate = true;
    }
}

function updatePublipostageFile() {
    if (confirm("Voulez-vous vraiment mettre √† jour le fichier de publipostage sur Google Drive ?")) {
        fetch("{{ url_for('export.trigger_publipostage_cron') }}", { method: "POST" })
            .then(response => response.json())
            .then(data => alert(data.message))
            .catch(error => alert("‚ùå Erreur lors de la mise √† jour : " + error));
    }
}

// --- Filtrage dynamique avec persistance ---
const searchInput = document.getElementById("filtre-benevole");
const savedFilter = localStorage.getItem("benevole_search_filter") || "";
if (savedFilter) {
    searchInput.value = savedFilter;
}

function applyFilter() {
    const filtre = searchInput.value.toLowerCase();
    localStorage.setItem("benevole_search_filter", filtre);

    document.querySelectorAll("#benevole-table tbody tr").forEach(row => {
        // Exclure le contenu de la colonne user_modif du texte recherch√©
        const cellules = Array.from(row.querySelectorAll("td"));
        const texteSansUserModif = cellules
            .filter(td => !td.classList.contains("col-user-modif")) // colonne marqu√©e comme user_modif
            .map(td => td.innerText)
            .join(" ")
            .toLowerCase();

        row.style.display = texteSansUserModif.includes(filtre) ? "" : "none";
    });
}

searchInput.addEventListener("input", applyFilter);
window.addEventListener("DOMContentLoaded", applyFilter);


// Scroll synchronis√©
const topScroll = document.getElementById("scroll-top");
const bottomScroll = document.getElementById("scroll-bottom");
const syncDiv = document.getElementById("sync-scroll");
const table = document.getElementById("benevole-table");
if (syncDiv && table) syncDiv.style.width = table.scrollWidth + "px";
topScroll.addEventListener("scroll", () => bottomScroll.scrollLeft = topScroll.scrollLeft);
bottomScroll.addEventListener("scroll", () => topScroll.scrollLeft = bottomScroll.scrollLeft);

// Photos au survol
document.querySelectorAll(".photo-hover-container").forEach(container => {
    const imgPath = container.dataset.img;
    let floating = null;
    container.addEventListener("mouseenter", () => {
        floating = document.createElement("img");
        floating.src = imgPath;
        floating.style.position = "fixed";
        floating.style.zIndex = "9999";
        floating.style.maxWidth = "150px";
        floating.style.maxHeight = "150px";
        floating.style.border = "1px solid #ccc";
        floating.style.background = "white";
        floating.style.boxShadow = "2px 2px 8px rgba(0,0,0,0.2)";
        floating.style.pointerEvents = "none";
        const rect = container.getBoundingClientRect();
        floating.style.left = `${rect.right + 10}px`;
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;
        floating.style.top = spaceBelow < 160 && spaceAbove > 160 ? `${rect.top - 160}px` : `${rect.top}px`;
        document.body.appendChild(floating);
    });
    container.addEventListener("mouseleave", () => {
        if (floating) {
            document.body.removeChild(floating);
            floating = null;
        }
    });
});


const SORT_KEY = "benevoles_sort_state";

let currentSort = JSON.parse(localStorage.getItem(SORT_KEY)) || {
    column: null,
    asc: true
};

function applySort(column, updateStorage = true) {
    const table = document.getElementById("benevole-table");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    const colIndex = column === "id" ? 1 : 2;

    rows.sort((a, b) => {
        let va = a.children[colIndex].innerText.trim();
        let vb = b.children[colIndex].innerText.trim();

        if (column === "id") {
            va = parseInt(va, 10);
            vb = parseInt(vb, 10);
            return currentSort.asc ? va - vb : vb - va;
        } else {
            return currentSort.asc
                ? va.localeCompare(vb, "fr", { sensitivity: "base" })
                : vb.localeCompare(va, "fr", { sensitivity: "base" });
        }
    });

    rows.forEach(tr => tbody.appendChild(tr));

    // UI : fl√®ches et √©tat actif
    document.querySelectorAll("th.sortable").forEach(th => {
        th.classList.remove("active");
        th.querySelector(".arrow").textContent = "‚ñ≤‚ñº";
    });

    const activeTh = document.querySelector(`th.sortable[data-sort="${column}"]`);
    if (activeTh) {
        activeTh.classList.add("active");
        activeTh.querySelector(".arrow").textContent = currentSort.asc ? "‚ñ≤" : "‚ñº";
    }

    if (updateStorage) {
        localStorage.setItem(SORT_KEY, JSON.stringify(currentSort));
    }
}

document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
        const column = th.dataset.sort;

        if (currentSort.column === column) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.column = column;
            currentSort.asc = true;
        }

        applySort(column);
    });
});

// üîÅ Appliquer le tri m√©moris√© au chargement
window.addEventListener("DOMContentLoaded", () => {
    if (currentSort.column) {
        applySort(currentSort.column, false);
    }
});

window.addEventListener("DOMContentLoaded", () => {

    const saved = localStorage.getItem(OPTIONS_KEY);
    if (!saved) return;

    const options = JSON.parse(saved);

    const urlParams = new URLSearchParams(window.location.search);

    if (!urlParams.getAll("columns").length && options.columns.length > 0) {

        options.columns.forEach(col => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "columns";
            input.value = col;
            document.getElementById("form-options").appendChild(input);
        });

        options.groups.forEach(grp => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "selected_groups";
            input.value = grp;
            document.getElementById("form-options").appendChild(input);
        });

        document.getElementById("form-options").submit();
    }
    // Recalculer √©tat des masters
    document.querySelectorAll(".toggle-master-checkbox").forEach(master => {
        const group = master.id.replace("toggle-", "");
        updateGroupCheckboxState(group);
    });

});

function resetFilters() {

    if (!confirm("R√©initialiser tous les filtres et options d'affichage ?")) {
        return;
    }

    // Supprimer filtres sauvegard√©s
    localStorage.removeItem("benevole_search_filter");
    localStorage.removeItem("benevoles_sort_state");
    localStorage.removeItem(OPTIONS_KEY);   // ‚Üê AJOUT ICI

    // Vider champ recherche
    const searchInput = document.getElementById("filtre-benevole");
    if (searchInput) searchInput.value = "";

    // Recharger la page sans param√®tres
    window.location.href = "{{ url_for('benevoles.benevoles') }}";
}


</script>
{% endblock %}
