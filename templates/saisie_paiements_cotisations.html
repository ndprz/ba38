{% extends "base_assos.html" %}
{% block title %}Saisie des paiements{% endblock %}

{% block content %}
<div class="container mt-4">

  <h2>ðŸ’³ Saisie des paiements de cotisations</h2>

  <!-- SÃ©lecteur annÃ©e -->
  <form method="get" class="mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">AnnÃ©e</label>
        <input type="number" name="annee"
               class="form-control"
               value="{{ annee or '' }}"
               required>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100">
          Afficher
        </button>
      </div>
    </div>
  </form>

    <a href="{{ url_for('traitements.saisie_paiements_cotisations', annee=annee, impayes=1) }}"
        class="btn btn-outline-danger btn-sm">
        ðŸ”Ž ImpayÃ©s uniquement
    </a>

    <a href="{{ url_for('traitements.saisie_paiements_cotisations', annee=annee) }}"
        class="btn btn-outline-secondary btn-sm">
        ðŸ“„ Tous
    </a>

    <a href="{{ url_for('traitements.export_cotisations_excel', annee=annee) }}"
        class="btn btn-success btn-sm">
        ðŸ“Š Export Excel
    </a>

    <div class="card mb-3">
        <div class="card-body">

            <h6>ðŸ“Š Recouvrement {{ annee }}</h6>

            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-success"
                    role="progressbar"
                    style="width: {{ taux_recouvrement }}%;">
                    {{ taux_recouvrement }} %
                </div>
            </div>

            <div class="mt-2">
                ðŸ’° {{ total_paye }} â‚¬ encaissÃ©s sur {{ total_facture }} â‚¬
            </div>

        </div>
    </div>

  {% if resultats %}

  <table class="table table-sm table-striped">
    <thead>
      <tr>
        <th>Facture</th>
        <th>Association</th>
        <th>Code VIF</th>
        <th>Compte comptable</th>
        <th class="text-end">Montant (â‚¬)</th>
        <th>Statut</th>
        <th>Date paiement</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for r in resultats %}
      <tr class="{% if r.statut == 'envoyee' and not r.date_paiement %}table-danger{% endif %}">
        <td>{{ r.numero_facture }}</td>
        <td>{{ r.nom_association }}</td>
        <td class="text-monospace">{{ r.code_vif }}</td>
        <td class="text-monospace">{{ r.compte_comptable or "" }}</td>
        <td class="text-end">{{ "%.2f"|format(r.montant) }}</td>
        <td>
            {% if r.statut == "paye" %}
                <span class="badge bg-success">PayÃ©</span>

            {% elif r.statut == "envoyee" %}
                <span class="badge bg-primary">EnvoyÃ©</span>

            {% elif r.statut == "calcule" %}
                <span class="badge bg-secondary">CalculÃ©</span>

            {% else %}
                <span class="badge bg-light text-dark">
                    {{ r.statut }}
                </span>
            {% endif %}
        </td>
        <td>{{ r.date_paiement or "" }}</td>
        <td>
          {% if r.statut != "paye" %}
          <form method="post" class="d-flex gap-2">
            <input type="hidden"
                   name="annee"
                   value="{{ annee }}">
            <input type="hidden"
                   name="cotisation_id"
                   value="{{ r.id }}">
            <input type="date"
                   name="date_paiement"
                   class="form-control"
                   required>
            <button class="btn btn-success btn-sm">
              Valider
            </button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Totaux -->
  <tfoot class="table-light fw-bold">
  <tr>
    <td colspan="4" class="text-end">TOTAL :</td>
    <td>{{ total_facture }} â‚¬</td>
    <td>{{ total_paye }} â‚¬ encaissÃ©s</td>
    <td>{{ total_restant }} â‚¬ restant</td>
  </tr>
  </tfoot>

  {% endif %}

</div>
{% endblock %}
