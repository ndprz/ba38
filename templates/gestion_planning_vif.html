{% extends "base_bene.html" %}
{% block title %}Gestion Planning VIF{% endblock %}


{% block content %}

<form method="post">

{# ============================== #
# ğŸ” Bandeau supÃ©rieur : titre + boutons
# ============================== #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Gestion du planning VIF</h2>

  <div class="d-flex gap-2">
    <button type="submit"
            name="action"
            value="enregistrer"
            class="btn btn-primary save-btn"
            disabled>
      ğŸ’¾ Enregistrer le planning
    </button>

    <a href="{{ url_for('planning_vif.creation_planning_vif', semaine=semaine) }}"
       class="btn btn-outline-primary">
      â¬…ï¸ Retour Ã  la crÃ©ation
    </a>

    <a href="{{ url_for('planning.planning_main') }}"
       class="btn btn-outline-secondary">
      ğŸ  Menu Planning
    </a>

    <a id="apercu-link"
       href="{{ url_for('planning_vif.apercu_planning_vif', semaine=semaine) }}"
       target="_blank"
       class="btn btn-outline-secondary">
      ğŸ”ˆï¸ AperÃ§u imprimable (A3)
    </a>
  </div>
</div>

{# âš ï¸ Indicateur modifications non enregistrÃ©es #}
<div id="unsaved-warning"
     class="alert alert-warning py-2 px-3 mb-3"
     style="display:none;">
  âš ï¸ Modifications non enregistrÃ©es
</div>

{# ============================== #
# ğŸ§¾ Tableau VIF
# ============================== #}
<div class="gestion-planning-container">
  <table class="table table-bordered table-striped table-sm">
    <thead>
      <tr>
        <th>Jour</th>
        <th>Semaine</th>
        <th>VIF matin</th>
        <th>VIF aprÃ¨s-midi</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>

      {% for ligne in lignes %}
      <tr class="jour-{{ ligne.jour|lower }}">
        <td>{{ ligne.jour|capitalize }}</td>
        <td>{{ ligne.semaine }}</td>

        <input type="hidden" name="ligne_ids[]" value="{{ ligne.id }}">

        {# Liste des bÃ©nÃ©voles dÃ©jÃ  affectÃ©s sur la ligne (titulaire + remplaÃ§ant) #}
        {% set deja_affectes = [] %}
        {% for j in range(1, 3) %}
          {% set titulaire = ligne['vif%02d_id' % j] %}
          {% set remplacant = ligne['vif%02d_remplacant' % j] %}
          {% if titulaire %}{% set _ = deja_affectes.append(titulaire) %}{% endif %}
          {% if remplacant %}{% set _ = deja_affectes.append(remplacant) %}{% endif %}
        {% endfor %}

        {# Colonnes matin(01) / aprÃ¨s-midi(02) #}
        {% for i in range(1, 3) %}
          {% set champ_id   = 'vif%02d_id' % i %}
          {% set champ_remp = 'vif%02d_remplacant' % i %}
          {% set champ_abs  = 'vif%02d_absent' % i %}

          {% set is_absent     = (ligne[champ_abs] or '')|lower == 'oui' %}
          {% set titulaire_id  = ligne[champ_id] %}
          {% set remplacant_id = ligne[champ_remp] %}
          {% set selected_id = remplacant_id if remplacant_id else titulaire_id %}

          {# --- Tri/Groupage : dâ€™abord saisie_vif='oui' --- #}
          {% set favoris = [] %}
          {% set autres = [] %}
          {% for b in benevoles %}
            {% set flag = (b.saisie_vif or b['saisie_vif'] or '') %}
            {% if flag|string|trim|lower == 'oui' %}
              {% set _ = favoris.append(b) %}
            {% else %}
              {% set _ = autres.append(b) %}
            {% endif %}
          {% endfor %}

          <td class="
              {% if is_absent and not remplacant_id %}absent-cell
              {% elif remplacant_id %}remplacant-cell
              {% endif %}
          ">
          <select name="vif{{ '%02d'|format(i) }}_ids[]"
                  class="form-control bene-select"
                  data-role="vif">

            <option value="">-- Aucun --</option>

            {% for bene in favoris %}
              <option value="{{ bene.id }}"
                      {% if bene.id == selected_id %}selected{% endif %}
                      style="color: green; font-weight:600;">
                âœ… {{ bene.nom }} {{ bene.prenom }}
                {% if is_absent and bene.id == titulaire_id %}(absent){% endif %}
                {% if is_absent and bene.id == remplacant_id %}(remplaÃ§ant){% endif %}
              </option>
            {% endfor %}

            {% if favoris and autres %}
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
            {% endif %}

            {% for bene in autres %}
              <option value="{{ bene.id }}"
                      {% if bene.id == selected_id %}selected{% endif %}
                      {% if is_absent and bene.id == titulaire_id %}style="color:red;"
                      {% elif is_absent and bene.id == remplacant_id %}style="color:green;"
                      {% endif %}>
                {{ bene.nom }} {{ bene.prenom }}
                {% if is_absent and bene.id == titulaire_id %}(absent){% endif %}
                {% if is_absent and bene.id == remplacant_id %}(remplaÃ§ant){% endif %}
              </option>
            {% endfor %}
          </select>

              {# ğŸ” Indicateur Ã©tat (comme les autres plannings) #}
              {% if remplacant_id %}
                  <div class="small text-success fw-bold mt-1"></div>
              {% elif is_absent %}
                  <div class="small text-danger fw-bold mt-1"></div>
              {% endif %}

              <input type="hidden"
                    name="vif{{ '%02d'|format(i) }}_remplacants[]"
                    value="{{ remplacant_id or '' }}">
          </td>

        {% endfor %}

        <td class="text-center">
          <button type="submit"
                  name="action"
                  value="supprimer_{{ ligne.id }}"
                  class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
        </td>
      </tr>
      {% endfor %}

    </tbody>
  </table>
</div>

{# ============================== #
# ğŸ”š Bandeau infÃ©rieur : mÃªmes boutons, alignÃ©s Ã  droite
# ============================== #}
<div class="d-flex justify-content-end gap-2 mt-3">
  <button type="submit"
          name="action"
          value="enregistrer"
          class="btn btn-primary save-btn"
          disabled>
    ğŸ’¾ Enregistrer le planning
  </button>

  <a href="{{ url_for('planning_vif.creation_planning_vif', semaine=semaine) }}"
     class="btn btn-outline-primary">
    â¬…ï¸ Retour Ã  la crÃ©ation
  </a>

  <a href="{{ url_for('planning.planning_main') }}"
     class="btn btn-outline-secondary">
    ğŸ  Menu Planning
  </a>

  <a id="apercu-link-bottom"
     href="{{ url_for('planning_vif.apercu_planning_vif', semaine=semaine) }}"
     target="_blank"
     class="btn btn-outline-secondary">
    ğŸ”ˆï¸ AperÃ§u imprimable (A3)
  </a>
</div>

</form>

{# ============================== #
ğŸ”§ Modale + JS commun
# ============================== #}
{% include "partials/quick_benevole_modal.html" %}
<script src="{{ url_for('static', filename='js/quick_benevole.js', v=10) }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  let planningDirty = false;

  const saveButtons = document.querySelectorAll(".save-btn");
  const warning = document.getElementById("unsaved-warning");
  const form = document.querySelector("form");
  const apercuTop = document.getElementById("apercu-link");
  const apercuBottom = document.getElementById("apercu-link-bottom");

  function setDirty() {
    if (planningDirty) return;
    planningDirty = true;
    saveButtons.forEach(btn => btn.disabled = false);
    if (warning) warning.style.display = "block";
  }

  if (form) {
    form.addEventListener("change", function (e) {
      const t = e.target;
      if (!t) return;
      if (t.matches("select, input[type='text'], input[type='number']")) {
        setDirty();
      }
    });
  }

  // backend a auto-modifiÃ© (nouveaux absents)
  {% if planning_auto_modified %}
    setDirty();
  {% endif %}

  function beforeUnloadHandler(e) {
    if (!planningDirty) return;
    e.preventDefault();
    e.returnValue = "";
  }
  window.addEventListener("beforeunload", beforeUnloadHandler);

  if (form) {
    form.addEventListener("submit", function () {
      planningDirty = false;
      window.removeEventListener("beforeunload", beforeUnloadHandler);
    });
  }

  function blockApercuIfDirty(e) {
    if (!planningDirty) return;
    e.preventDefault();
    alert(
      "â„¹ï¸ Lâ€™aperÃ§u reflÃ¨te uniquement les donnÃ©es enregistrÃ©es.\n" +
      "Veuillez dâ€™abord cliquer sur Â« ğŸ’¾ Enregistrer le planning Â», puis relancer lâ€™aperÃ§u."
    );
  }

  if (apercuTop) apercuTop.addEventListener("click", blockApercuIfDirty);
  if (apercuBottom) apercuBottom.addEventListener("click", blockApercuIfDirty);

});
</script>

<style>
.absent-cell {
    background-color: #ffe0e0 !important;
}

.remplacant-cell {
    background-color: #e6f4ea !important;
}
</style>


{% endblock %}
