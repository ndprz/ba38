{% extends "base_bene.html" %}
{% block title %}Gestion Planning PesÃ©e{% endblock %}

{% block content %}

<form method="post">

{# ============================== #
# ğŸ” Bandeau supÃ©rieur : titre + boutons de navigation
# ============================== #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Gestion du planning PesÃ©e</h2>

    <div class="d-flex gap-2">
    <button type="submit"
            name="action"
            value="enregistrer"
            class="btn btn-primary save-btn"
            disabled>
      ğŸ’¾ Enregistrer le planning
    </button>

    {# Bouton retour vers la page de crÃ©ation du planning pesÃ©e #}
    <a href="{{ url_for('planning_pesee.creation_planning_pesee', semaine=semaine) }}" class="btn btn-outline-primary">
      â¬…ï¸ Retour Ã  la crÃ©ation
    </a>

    {# Bouton retour vers le menu principal des plannings #}
    <a href="{{ url_for('planning.planning_main') }}" class="btn btn-outline-secondary">
      ğŸ  Menu Planning
    </a>

    {# Bouton aperÃ§u imprimable (dÃ©jÃ  existant) #}
    <a id="apercu-link"
       href="{{ url_for('planning_pesee.apercu_planning_pesee', semaine=semaine) }}"
       target="_blank"
       class="btn btn-outline-secondary">
      ğŸ”ˆï¸ AperÃ§u imprimable (A3)
    </a>
  </div>
</div>


{# âš ï¸ Indicateur modifications non enregistrÃ©es #}
<div id="unsaved-warning"
     class="alert alert-warning py-2 px-3 mb-3"
     style="display:none;">
  âš ï¸ Modifications non enregistrÃ©es
</div>


{# ============================== #
# ğŸ§¾ Formulaire principal de gestion du planning pesÃ©e
# ============================== #}
  <div class="gestion-planning-container">
    <table class="table table-bordered table-striped table-sm">
      <thead>
        <tr>
          <th>Jour</th>
          <th>Semaine</th>
          <th>PesÃ©e 1</th>
          <th>PesÃ©e 2</th>
          <th>PesÃ©e 3</th>
          <th>PesÃ©e 4</th>
          <th>PesÃ©e 5</th>
          <th>PesÃ©e 6</th>
          <th>PesÃ©e 7</th>
          <th>PesÃ©e 8</th>
          <th>PesÃ©e 9</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>

        {# ============================ #
          Boucle sur toutes les lignes du planning
        # ============================ #}
        {% for ligne in lignes %}
        <tr class="jour-{{ ligne.jour|lower }}">
          <td>{{ ligne.jour|capitalize }}</td>
          <td>{{ ligne.semaine }}</td>
          <input type="hidden" name="ligne_ids[]" value="{{ ligne.id }}">

          {# Liste temporaire des bÃ©nÃ©voles dÃ©jÃ  affectÃ©s (titulaires + remplaÃ§ants) #}
          {% set deja_affectes = [] %}
          {% for j in range(1, 10) %}
            {% set titulaire = ligne['pesee%02d_id' % j] %}
            {% set remplacant = ligne['pesee%02d_remplacant' % j] %}
            {% if titulaire %}{% set _ = deja_affectes.append(titulaire) %}{% endif %}
            {% if remplacant %}{% set _ = deja_affectes.append(remplacant) %}{% endif %}
          {% endfor %}

          {# ============================ #
            Colonnes PesÃ©e 1 â†’ 9 
          # ============================ #}
          {% for i in range(1, 10) %}
            {% set champ_id   = 'pesee%02d_id' % i %}
            {% set champ_remp = 'pesee%02d_remplacant' % i %}
            {% set champ_abs  = 'pesee%02d_absent' % i %}
            {% set is_absent      = (ligne[champ_abs] or '') == 'oui' %}
            {% set titulaire_id   = ligne[champ_id] %}
            {% set remplacant_id  = ligne[champ_remp] %}
            {% set selected_id    = ligne['pesee%02d_effectif' % i] %}

            {# SÃ©paration entre favoris et autres selon le champ prep_pesee #}
            {% set favoris = benevoles|selectattr('prep_pesee','equalto','oui')|list %}
            {% set autres  = benevoles|rejectattr('prep_pesee','equalto','oui')|list %}

            <td class="{% if is_absent and not remplacant_id %}absent-cell{% endif %}">
              <select name="pesee{{ '%02d'|format(i) }}_ids[]"
                      class="form-control form-select-sm bene-select"
                      data-role="pesee">
                {# â• Ajout rapide dâ€™un bÃ©nÃ©vole #}
                <option value="__add__">â• Ajouter un bÃ©nÃ©voleâ€¦</option>
                <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

                {# Option vide (aucun bÃ©nÃ©vole affectÃ©) #}
                <option value="" {% if not titulaire_id and not remplacant_id %}selected{% endif %}>-- Aucun --</option>

                {# BÃ©nÃ©voles prioritaires (prep_pesee = oui) #}
                {% for bene in favoris %}
                  {% set is_selected         = bene.id == selected_id %}
                  {% set is_remplacant       = bene.id == remplacant_id %}
                  {% set is_absent_titulaire = is_selected and is_absent and not remplacant_id %}
                  {% set is_already_assigned = (bene.id in deja_affectes) and not is_selected %}
                  <option value="{{ bene.id }}"
                          {% if is_selected %}selected{% endif %}
                          {% if is_remplacant %}style="color: green;"{% elif is_absent_titulaire %}style="color: red;"{% elif is_already_assigned %}style="color: orange;"{% endif %}>
                    âœ… {{ bene.nom }} {{ bene.prenom }}
                    {% if is_remplacant %}(remplaÃ§ant)
                    {% elif is_absent_titulaire %}(absent)
                    {% elif is_already_assigned %}(dÃ©jÃ  affectÃ©)
                    {% endif %}
                  </option>
                {% endfor %}

                {% if favoris and autres %}<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>{% endif %}

                {# Autres bÃ©nÃ©voles #}
                {% for bene in autres %}
                  {% set is_selected         = bene.id == selected_id %}
                  {% set is_remplacant       = is_selected and is_absent and remplacant_id %}
                  {% set is_absent_titulaire = is_selected and is_absent and not remplacant_id %}
                  {% set is_already_assigned = (bene.id in deja_affectes) and not is_selected %}
                  <option value="{{ bene.id }}"
                          {% if is_selected %}selected{% endif %}
                          {% if is_remplacant %}style="color: green;"{% elif is_absent_titulaire %}style="color: red;"{% elif is_already_assigned %}style="color: orange;"{% endif %}>
                    {{ bene.nom }} {{ bene.prenom }}
                    {% if is_remplacant %}(remplaÃ§ant)
                    {% elif is_absent_titulaire %}(absent)
                    {% elif is_already_assigned %}(dÃ©jÃ  affectÃ©)
                    {% endif %}
                  </option>
                {% endfor %}
              </select>

              {# Champ cachÃ© conservÃ© pour compatibilitÃ© avec la route Flask #}
              <input type="hidden"
                     name="pesee{{ '%02d'|format(i) }}_remplacants[]"
                     value="{{ remplacant_id or '' }}">
            </td>
          {% endfor %}

          {# Bouton de suppression de la ligne #}
          <td class="text-center">
            <button type="submit" name="action" value="supprimer_{{ ligne.id }}" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</form>


{# ============================== #
ğŸ”§ Modale + JavaScript commun
# ============================== #}
{% include "partials/quick_benevole_modal.html" %}
<script src="{{ url_for('static', filename='js/quick_benevole.js', v=9) }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let isDirty = false;

  const warning = document.getElementById("unsaved-warning");
  const saveButtons = document.querySelectorAll(".save-btn");
  const form = document.querySelector("form");
  const apercuLink = document.getElementById("apercu-link");

  function markDirty() {
    if (isDirty) return;
    isDirty = true;

    saveButtons.forEach(btn => btn.disabled = false);
    if (warning) warning.style.display = "block";
  }

  // âœ… Si le serveur a auto-modifiÃ© (nouvel absent dÃ©tectÃ©), on force l'Ã©tat "dirty"
  {% if planning_auto_modified %}
    markDirty();
  {% endif %}

  // ğŸ” DÃ©tection de toute modification utilisateur
  document.querySelectorAll("form select, form input").forEach(el => {
    el.addEventListener("change", markDirty);
  });

  // âš ï¸ Bloquer l'aperÃ§u si non enregistrÃ©
  if (apercuLink) {
    apercuLink.addEventListener("click", function (e) {
      if (isDirty) {
        e.preventDefault();
        alert(
          "â„¹ï¸ Lâ€™aperÃ§u reflÃ¨te uniquement les donnÃ©es enregistrÃ©es.\n" +
          "Veuillez dâ€™abord cliquer sur Â« ğŸ’¾ Enregistrer le planning Â»."
        );
      }
    });
  }

  // âš ï¸ Avertissement sortie page
  function beforeUnloadHandler(e) {
    if (!isDirty) return;
    e.preventDefault();
    e.returnValue = "";
  }
  window.addEventListener("beforeunload", beforeUnloadHandler);

  // âœ… AprÃ¨s submit : on dÃ©sactive l'avertissement
  if (form) {
    form.addEventListener("submit", function () {
      isDirty = false;
      window.removeEventListener("beforeunload", beforeUnloadHandler);
    });
  }
});
</script>

{# ============================== #
ğŸ¨ Styles complÃ©mentaires
# ============================== #}
<style>
  .absent-cell {
    background-color: #ffe0e0 !important;
  }
</style>

{% endblock %}
