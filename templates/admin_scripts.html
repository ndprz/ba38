{% extends "base_assos.html" %}
{% block title %}Administration DÃ©veloppement{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>ğŸ› ï¸ Administration DÃ©veloppement</h2>
  {% if version_msg %}
    <p class="text-muted">ğŸš€ Version actuelle : {{ version_msg }}</p>
  {% endif %}

  <p>Cette page permet d'exÃ©cuter des scripts systÃ¨me depuis l'interface web (rÃ©servÃ©e aux admins).</p>

  <h3 class="mt-4">ğŸ“¡ Connexions actives</h3>
  {% if connexions_actives %}
    <table class="table table-bordered table-hover table-sm mt-3">
      <thead class="table-light">
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>Environnement</th>
          <th>Connexion</th>
          <th>DerniÃ¨re activitÃ©</th>
          <th>Actif</th>
        </tr>
      </thead>
      <tbody>
      {% for ligne in connexions_actives %}
        <tr class="{% if ligne.actif == 'oui' %}table-success{% else %}table-secondary{% endif %}">
          <td>{{ ligne.username }}</td>
          <td>{{ ligne.email }}</td>
          <td>{{ ligne.environ }}</td>
          <td>{{ ligne.connexion_time }}</td>
          <td>{{ ligne.last_seen }}</td>
          <td class="text-center">
            {% if ligne.actif == 'oui' %}âœ…{% else %}âŒ{% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">Aucune session active dÃ©tectÃ©e.</p>
  {% endif %}

  <div class="row mt-4">
    <div class="col-md-6">
      <form method="POST"><input type="hidden" name="script_name" value="backup_prod.sh">
        <button class="btn btn-warning mb-2 w-100">ğŸ“† Lancer backup_prod.sh</button>
      </form>
      <a href="{{ url_for('rename.rename_field') }}" class="btn btn-outline-warning mb-2 w-100">
        âœï¸ Renommer un champ dans les bases SQLite
      </a>
      <form method="POST"><input type="hidden" name="script_name" value="deploy_to_prod.sh">
        <button class="btn btn-success mb-2 w-100">ğŸš€ Lancer deploy_to_prod.sh</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="enable_maintenance.sh">
        <button class="btn btn-danger mb-2 w-100">ğŸ”’ Activer le mode maintenance</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="disable_maintenance.sh">
        <button class="btn btn-primary mb-2 w-100">âœ… DÃ©sactiver le mode maintenance</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="status_site.sh">
        <button class="btn btn-info mb-2 w-100">ğŸ” VÃ©rifier Ã©tat du site</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="sync_type_champ.py">
        <button class="btn btn-outline-success mb-2 w-100">ğŸ› ï¸ Synchroniser les paramÃ¨tres type_champ</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="check_schema_diff.sh">
        <button class="btn btn-outline-dark mb-2 w-100">ğŸ§¾ VÃ©rifier diff schÃ©ma & paramÃ¨tres</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="migrate_schema_and_data_dev_to_prod.py">
        <button class="btn btn-warning mb-2 w-100">ğŸ” Synchroniser les nouvelles tables DEV â†’ PROD</button>
      </form>
      <a class="btn btn-outline-dark mb-2 w-100" href="{{ url_for('test_email_api') }}">
        ğŸ“¤ Tester lâ€™envoi de mail (API Mailjet)
      </a>
      <a href="{{ url_for('debug_bp.run_sync_test_schemas') }}" class="btn btn-outline-primary mb-2 w-100">
        ğŸ”„ Synchroniser les bases TEST (schÃ©ma + donnÃ©es)
      </a>
      <form method="POST" action="{{ url_for('debug_bp.restaurer_version') }}">
        <button type="submit" class="btn btn-outline-danger mb-2 w-100">
          ğŸ” Restaurer une version prÃ©cÃ©dente de la PROD
        </button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="recreer_table_benevoles_inactifs.py">
        <button class="btn btn-outline-danger mb-2 w-100">ğŸ—‚ RecrÃ©er la table des bÃ©nÃ©voles inactifs</button>
      </form>

      <form method="POST"><input type="hidden" name="script_name" value="create_test_databases.py">
        <button class="btn btn-outline-primary mb-2 w-100">ğŸ§© CrÃ©er les bases de test anonymisÃ©es</button>
      </form>


    </div>

    <div class="col-md-6">
      <form method="POST"><input type="hidden" name="script_name" value="check_env.py">
        <button class="btn btn-outline-secondary mb-2 w-100">ğŸ” VÃ©rifier les variables d'environnement</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="read_env.py">
        <button class="btn btn-outline-info mb-2 w-100">ğŸ“„ Afficher le fichier .env (prod)</button>
      </form>

      <form method="POST"><input type="hidden" name="script_name" value="fix_permissions.sh">
        <button class="btn btn-outline-dark mb-2 w-100">ğŸ§¼ Corriger les permissions des scripts</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="fix_line_endings.sh">
        <button class="btn btn-outline-dark mb-2 w-100">ğŸ§½ Convertir les fins de ligne (CRLF â†’ LF)</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="update_benevoles_schema_prod.py">
        <button class="btn btn-outline-dark mb-2 w-100">ğŸ” Mettre Ã  jour structure des bÃ©nÃ©voles (PROD)</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="update_associations_schema_prod.py">
        <button class="btn btn-outline-dark mb-2 w-100">ğŸ” Mettre Ã  jour structure des associations (PROD)</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="verify_env_consistency.py">
        <button class="btn btn-outline-dark mb-2 w-100">ğŸ§ª VÃ©rifier la base SQLite utilisÃ©e</button>
      </form>
      <form method="POST"><input type="hidden" name="script_name" value="cleanup_backups.py">
        <button class="btn btn-outline-danger mb-2 w-100">ğŸ§¹ Nettoyer les anciennes sauvegardes</button>
      </form>
      <a href="{{ url_for('static', filename='docs/Documentation_Admin_BA380.pdf') }}" class="btn btn-outline-primary mb-2 w-100" download>
        ğŸ“„ TÃ©lÃ©charger la documentation dâ€™administration
      </a>
      <a href="{{ url_for('debug_bp.deploy_log') }}" class="btn btn-outline-secondary mb-2 w-100">
        ğŸ“‹ Historique des dÃ©ploiements

      </a>
      <a href="{{ url_for('debug_bp.where_are_my_logs') }}" class="btn btn-outline-dark mb-2 w-100">
        ğŸ“ Voir les chemins et fichiers utilisÃ©s
      </a>
      <a href="{{ url_for('debug_bp.compare_db_full') }}" class="btn btn-outline-dark mb-2 w-100">
        ğŸ§¾ Comparaison complÃ¨te schÃ©ma + paramÃ¨tres
      </a>
      <a href="{{ url_for('debug_bp.git_log') }}" class="btn btn-outline-dark mb-2 w-100">
        ğŸªµ Historique Git (commits)
      </a>
      <a href="{{ url_for('debug_bp.check_drive_ids') }}" class="btn btn-outline-dark mb-2 w-100">
        ğŸ” VÃ©rifier les IDs Google Drive
      </a>
    </div>
  </div>

  {% if output %}
    <div class="alert alert-info alert-dismissible fade show mt-4" role="alert">
      <strong>ğŸ’» RÃ©sultat de {{ script_name }} :</strong><br>
      <pre class="mb-0" style="white-space: pre-wrap;">{{ output }}</pre>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
  {% endif %}

  {% if output %}
  <div class="mt-4">
    <h5>ğŸ“¦ Fichiers restaurÃ©s :</h5>
    <pre style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1em; border: 1px solid #ccc;">{{ output }}</pre>
  </div>
  {% endif %}



  <hr>
  <h4>ğŸ“œ Journal des connexions (fichier brut)</h4>
  <pre style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border: 1px solid #ccc;">
{% for ligne in connexions_log %}
{{ ligne.strip() }}
{% endfor %}
  </pre>
  <hr>
    <h4>ğŸ§¾ Historique des connexions / dÃ©connexions</h4>
    <table class="table table-striped table-sm mt-2">
      <thead class="table-light">
        <tr>
          <th>Email</th>
          <th>Utilisateur</th>
          <th>Action</th>
          <th>Horodatage</th>
          <th>IP</th>
        </tr>
      </thead>
      <tbody>
        {% for ligne in connexions_historiques %}
        <tr>
          <td>{{ ligne.email }}</td>
          <td>{{ ligne.username }}</td>
          <td>{{ ligne.action|upper }}</td>
          <td>{{ ligne.timestamp.replace("T", " ")[:19] }}</td>
          <td>{{ ligne.ip or "?" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>


</div>
{% endblock %}
