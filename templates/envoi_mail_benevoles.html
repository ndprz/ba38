{% extends "base_bene.html" %}
{% block title %}Envoi de mail bÃ©nÃ©voles{% endblock %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ğŸ“§ Envoi d'un mail (bÃ©nÃ©voles)</h2>
    <a href="{{ retour_url or url_for('benevoles.benevoles') }}" class="btn btn-secondary">
      â¬…ï¸ Retour
    </a>
  </div>

  <a href="{{ url_for('mail_bene.messages_predefinis_benevoles') }}" class="btn btn-outline-secondary mt-2 mb-3">
    âš™ï¸ GÃ©rer les messages prÃ©-enregistrÃ©s
  </a>

  <!-- ğŸ”¹ Filtrage par fonction -->
  <form method="get" class="mb-4 border rounded p-3 bg-light">
    <label class="form-label fw-bold">Filtrer par fonction :</label>
    <div class="d-flex flex-wrap" style="gap: 1rem;">
      {% for field, label in all_fonctions %}
        <div class="form-check">
          <input class="form-check-input"
                 type="checkbox"
                 name="fonctions"
                 id="f_{{ field }}"
                 value="{{ field }}"
                 {% if field in selected_fonctions %}checked{% endif %}
                 onchange="this.form.submit()">
          <label class="form-check-label" for="f_{{ field }}">{{ label }}</label>
        </div>
      {% endfor %}
    </div>
    {% if selected_fonctions %}
      <p class="mt-2 text-muted small">
        â¤ {{ destinataires|length }} bÃ©nÃ©vole(s) correspondant(s) aux critÃ¨res sÃ©lectionnÃ©s.
      </p>
    {% endif %}
  </form>

  <!-- ğŸ”¹ Formulaire principal -->
  <form id="mailForm" class="mt-3" onsubmit="ouvrirGmail(); return false;">
    <div class="mb-3">
      <label class="form-label">Destinataires :</label>
      <div class="border p-2" style="max-height: 300px; overflow-y: auto;">
        <div class="mb-2">
          <input type="checkbox" id="select_all" onclick="toggleAll(this)">
          <label for="select_all"><strong>Tout sÃ©lectionner</strong></label>
        </div>
        <hr class="my-1">
        {% for d in destinataires %}
          <div>
            <input type="checkbox" name="destinataires" value="{{ d.email }}" id="dest{{ loop.index }}">
            <label for="dest{{ loop.index }}">
              <strong>{{ d.prenom }} {{ d.nom }}</strong>
              <span class="text-muted">â€” {{ d.email }}</span>
            </label>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="mb-3">
      <label for="sujet" class="form-label">Sujet :</label>
      <input type="text" name="sujet" id="sujet" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="message" class="form-label">Message :</label>
      <textarea name="message" id="message" rows="6" class="form-control"></textarea>
    </div>

    <div class="mb-3">
      <label for="modele" class="form-label">Utiliser un message prÃ©-enregistrÃ© :</label>
      <select name="modele" id="modele" class="form-select">
        <option value="">-- Aucun --</option>
        {% for m in messages %}
          <option value="{{ m.id }}" data-titre="{{ m.titre|e }}">{{ m.titre }}</option>
        {% endfor %}
      </select>
    </div>

    {% for m in messages %}
      <textarea id="modele-{{ m.id }}" class="d-none" style="display:none;">{{ m.contenu }}</textarea>
    {% endfor %}

    <div class="mt-4 d-flex justify-content-between align-items-center">
    <a href="{{ retour_url or url_for('benevoles.benevoles') }}" class="btn btn-secondary">
        â¬…ï¸ Retour
    </a>
    <button type="button" class="btn btn-primary" onclick="ouvrirGmail()">
        ğŸ“¤ Ouvrir Gmail
    </button>
    </div>
  </form>
</div>

<script>
/* ============================================================
   ğŸ“§ Envoi mail bÃ©nÃ©voles - Version finale
   - "Ã€ :" = adresse de l'utilisateur connectÃ© (Flask)
   - "CCI :" = bÃ©nÃ©voles cochÃ©s
   - Compatible Chrome / Firefox / Edge / mobile
   ============================================================ */

function toggleAll(master) {
  // âœ… coche/dÃ©coche tous les destinataires
  document.querySelectorAll('input[name="destinataires"]').forEach(cb => cb.checked = master.checked);
}

document.addEventListener("DOMContentLoaded", function () {
  const select = document.getElementById("modele");
  const textarea = document.getElementById("message");
  const sujet = document.getElementById("sujet");

  // ğŸ”¹ Quand on choisit un message prÃ©-enregistrÃ©
  select.addEventListener("change", function () {
    const id = this.value;
    if (id) {
      const source = document.getElementById("modele-" + id);
      textarea.value = source ? source.value : "";
      const opt = this.options[this.selectedIndex];
      if (sujet && !sujet.value && opt && opt.dataset.titre) {
        sujet.value = opt.dataset.titre;
      }
    } else {
      textarea.value = "";
    }
  });
});


// ============================================================
// ğŸ”¹ Fonction dâ€™ouverture Gmail
// ============================================================
function ouvrirGmail() {
  // ğŸ“¨ RÃ©cupÃ¨re tous les bÃ©nÃ©voles cochÃ©s
  const emails = Array.from(document.querySelectorAll('input[name="destinataires"]:checked'))
    .map(cb => cb.value.trim())
    .filter(e => e !== "");

  // ğŸ§¾ Sujet et corps du message
  const sujet = encodeURIComponent(document.getElementById("sujet").value || "");
  const message = encodeURIComponent(document.getElementById("message").value || "");

  if (emails.length === 0) {
    alert("âŒ Merci de sÃ©lectionner au moins un destinataire.");
    return;
  }

  // ğŸ§ Email de l'utilisateur connectÃ© (injectÃ© depuis Flask)
  const userEmail = "{{ user_email or '' }}";

  // ğŸ§  Si l'utilisateur n'a pas d'email, on le signale
  if (!userEmail) {
    alert("âš ï¸ Votre compte nâ€™a pas dâ€™adresse email enregistrÃ©e.\nLe champ 'Ã€ :' restera vide.");
  }

  // âœ‰ï¸ Construction de lâ€™URL Gmail
  const to = encodeURIComponent(userEmail);  // "Ã€ :" = utilisateur connectÃ©
  const bcc = encodeURIComponent(emails.join(",")); // "CCI :" = bÃ©nÃ©voles cochÃ©s
  const url = `https://mail.google.com/mail/?view=cm&fs=1&tf=1&to=${to}&bcc=${bcc}&su=${sujet}&body=${message}`;

  // ğŸªŸ Ouvre Gmail dans un nouvel onglet
  window.open(url, "_blank");
}
</script>

{% endblock %}
