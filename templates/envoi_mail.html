{% extends "base_assos.html" %}
{% block title %}Envoi de mail{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>üìß Envoi d'un mail</h2>

  <!-- ‚ûï On passe assoc_id -->
  <a href="{{ url_for('mail.messages_predefinis', assoc_id=assoc_id) }}" class="btn btn-outline-secondary mt-3">
    ‚öôÔ∏è G√©rer les messages pr√©-enregistr√©s
  </a>

  {% if retour_url %}
    <a href="{{ retour_url }}" class="btn btn-secondary mt-3">‚¨ÖÔ∏è Retour √† la fiche partenaire</a>
  {% endif %}

  <form method="post" class="mt-3">
    <div class="mb-3">
      <label class="form-label">Destinataires :</label>
      <div class="border p-2" style="max-height: 300px; overflow-y: auto;">

        <div class="mb-2">
          <input type="checkbox" id="select_all" onclick="toggleAll(this)">
          <label for="select_all"><strong>Tout s√©lectionner</strong></label>
        </div>
        <hr class="my-1">

        {% for d in destinataires %}
          <div>
            <input type="checkbox" name="destinataires" value="{{ d.email }}" id="dest{{ loop.index }}">
            <label for="dest{{ loop.index }}">
              <strong>{{ d.assoc_nom }}</strong> ‚Äî {{ d.fonction }} :
              <span class="text-muted">{{ d.email }}</span>
            </label>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="mb-3">
      <label for="sujet" class="form-label">Sujet :</label>
      <input type="text" name="sujet" id="sujet" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="message" class="form-label">Message :</label>
      <textarea name="message" id="message" rows="6" class="form-control"></textarea>
    </div>

    <div class="mb-3">
      <label for="modele" class="form-label">Utiliser un message pr√©-enregistr√© :</label>
      <select name="modele" id="modele" class="form-select">
        <option value="">-- Aucun --</option>
        {% for m in messages %}
          <option value="{{ m.id }}" data-titre="{{ m.titre|e }}">{{ m.titre }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Mod√®les cach√©s (texte brut) -->
    {% for m in messages %}
      <textarea id="modele-{{ m.id }}" class="d-none" style="display:none;">{{ m.contenu }}</textarea>
    {% endfor %}

    {% if gmail_url %}
      <div class="alert alert-success mt-3">
        ‚úÖ Message pr√™t √† envoyer.
      </div>
      <a href="{{ gmail_url }}" target="_blank" class="btn btn-success">‚úâÔ∏è Ouvrir Gmail</a>
      <a href="{{ retour_url }}" class="btn btn-secondary">‚¨ÖÔ∏è Retour</a>
    {% else %}
      <button type="submit" class="btn btn-primary">üì§ Ouvrir Gmail</button>
    {% endif %}
  </form>
</div>

<script>
function toggleAll(master) {
  document.querySelectorAll('input[name="destinataires"]').forEach(cb => cb.checked = master.checked);
}
document.addEventListener("DOMContentLoaded", function () {
  const select = document.getElementById("modele");
  const textarea = document.getElementById("message");
  const sujet = document.getElementById("sujet");
  select.addEventListener("change", function () {
    const id = this.value;
    if (id) {
      const source = document.getElementById("modele-" + id);
      textarea.value = source ? source.value : "";
      const opt = this.options[this.selectedIndex];
      if (sujet && !sujet.value && opt && opt.dataset.titre) {
        sujet.value = opt.dataset.titre;
      }
    } else {
      textarea.value = "";
    }
  });
});
</script>
{% endblock %}
