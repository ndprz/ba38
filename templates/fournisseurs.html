{% extends "base_frs.html" %}

{% block title %}Liste des Fournisseurs{% endblock %}

{% block content %}
<h2>Liste des Fournisseurs</h2>

<!-- ðŸ”Ž Barre de recherche + boutons -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">

  <!-- Recherche -->
  <div class="flex-grow-1 me-3">
    <input type="text" id="searchInput" class="form-control" placeholder="ðŸ” Rechercher un fournisseur...">
  </div>

  <!-- Boutons -->
  <div class="d-flex" style="gap: 10px;">
    {% if rows %}
    <a href="{{ url_for('fournisseurs.export_fournisseurs_excel') }}" class="btn btn-outline-primary">
      ðŸ“Š Exporter
    </a>
    {% endif %}

    {% if not lecture_seule %}
    <a href="{{ url_for('fournisseurs.create_fournisseur') }}" class="btn btn-success">
      âž• CrÃ©er
    </a>
    {% else %}
    <button class="btn btn-success" disabled title="Vous n'avez pas les droits pour crÃ©er un fournisseur.">
      âž• CrÃ©er
    </button>
    {% endif %}
  </div>
</div>

<hr>

{% if rows %}
<!-- ðŸŽ¯ Scroll haut synchronisÃ© -->
<div id="scroll-top" style="overflow-x: auto; height: 20px; margin-bottom: 5px;">
    <div id="sync-scroll" style="height: 1px;"></div>
</div>

<!-- ðŸ“Š Tableau principal avec colonnes figÃ©es -->
<div id="scroll-bottom"
     style="overflow-x: auto;
            overflow-y: auto;
            height: 65vh;
            white-space: nowrap;"><table class="table table-bordered table-sticky" id="fournisseurs-table">
    <thead>
        <tr>
            <th class="sticky-col sticky-col-1">Action</th>
            <th class="sticky-col sticky-col-2">ID</th>
            <th class="sticky-col sticky-col-3">Nom</th>
            <th>Drive</th>
            <th>Code VIF</th>
            <th>Enseigne</th>
            <th>SociÃ©tÃ©</th>
            <th>Type</th>  {# <-- type_frs ajoutÃ© #}
            <th>Mobile</th>
            <th>TÃ©lÃ©phone</th>
            <th>Email</th>
            <th>Adresse</th>
            <th>Adresse 2</th>
            <th>CP</th>
            <th>Ville</th>
            <th>Notes</th>
            <th>Actif</th>
            <th>Date crÃ©ation</th>
            <th>Date modif</th>
            <th>Utilisateur</th>
        </tr>
    </thead>
    <tbody>
        {% for row in rows %}
        <tr>
            <td class="sticky-col sticky-col-1">
                <form method="GET" action="{{ url_for('fournisseurs.update_fournisseur', fournisseur_id=row['id']) }}" style="display:inline;">
                    <button type="submit" class="btn btn-primary btn-sm">Modifier</button>
                </form>
            </td>

            <td class="sticky-col sticky-col-2">{{ row['id'] }}</td>
            <td class="sticky-col sticky-col-3">{{ row['nom'] }}</td>
            <td>
              {% if row['drive_link'] %}
                <a href="{{ row['drive_link'] }}" target="_blank">ðŸ“‚ Dossier</a>
              {% endif %}
            </td>
            <td>{{ row['code_vif'] }}</td>
            <td>{{ row['enseigne'] }}</td>
            <td>{{ row['societe'] }}</td>
            <td>{{ row['type_frs'] }}</td>  {# <-- affichage type_frs #}
            <td>{{ row['tel_mobile'] }}</td>
            <td>{{ row['tel'] }}</td>
            <td>{{ row['mail'] }}</td>
            <td>{{ row['adresse'] }}</td>
            <td>{{ row['adresse2'] }}</td>
            <td>{{ row['cp'] }}</td>
            <td>{{ row['ville'] }}</td>
            <td>{{ row['notes'] }}</td>
            <td>{{ row['actif'] }}</td>
            <td>{{ row['date_creation'] }}</td>
            <td>{{ row['date_modif'] }}</td>
            <td>{{ row['user_modif'] }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% else %}
<p>Aucun fournisseur trouvÃ©.</p>
{% endif %}

<!-- ðŸ” JS : dynamique et synchronisation -->
<script>
const topScroll = document.getElementById("scroll-top");
const bottomScroll = document.getElementById("scroll-bottom");
const syncDiv = document.getElementById("sync-scroll");
const table = document.getElementById("fournisseurs-table");
if (syncDiv && table) syncDiv.style.width = table.scrollWidth + "px";
topScroll.addEventListener("scroll", () => bottomScroll.scrollLeft = topScroll.scrollLeft);
bottomScroll.addEventListener("scroll", () => topScroll.scrollLeft = bottomScroll.scrollLeft);


// ===============================
// ðŸ”Ž FILTRE RAPIDE FOURNISSEURS
// ===============================

const searchInput = document.getElementById("searchInput");

let fournisseurRows = [];

function initFiltreCacheFournisseurs() {

    const rows = document.querySelectorAll("#fournisseurs-table tbody tr");

    fournisseurRows = Array.from(rows).map(row => ({
        element: row,
        text: row.innerText.toLowerCase()
    }));
}

function applyFiltreFournisseurs() {

    const filtre = searchInput.value.toLowerCase();
    let visibleCount = 0;

    fournisseurRows.forEach(obj => {

        const match = obj.text.includes(filtre);
        obj.element.style.display = match ? "" : "none";

        if (match) visibleCount++;
    });

    localStorage.setItem("fournisseurs_search_filter", filtre);
}

/* Debounce */
let filtreTimeout;

searchInput.addEventListener("input", function() {

    clearTimeout(filtreTimeout);

    filtreTimeout = setTimeout(() => {
        applyFiltreFournisseurs();
    }, 120);
});

/* Ã‰chap */
searchInput.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
        this.value = "";
        applyFiltreFournisseurs();
        e.preventDefault();
    }
});

/* Initialisation */
window.addEventListener("DOMContentLoaded", () => {

    initFiltreCacheFournisseurs();

    const saved = localStorage.getItem("fournisseurs_search_filter");
    if (saved) {
        searchInput.value = saved;
        applyFiltreFournisseurs();
    }
});

</script>
{% endblock %}
