{% extends "base_bene.html" %}
{% block title %}Modifier les informations du b√©n√©vole{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- üîπ En-t√™te : titre + info derni√®re modification -->
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
        <h2 class="mb-0">Modifier les informations du b√©n√©vole</h2>
        <div class="text-end text-muted small ms-auto">
            üïí Derni√®re modification :
            {% if benevole.date_modif and benevole.heure_modif %}
                {{ benevole.date_modif }} √† {{ benevole.heure_modif }},
            {% else %}
                inconnue,
            {% endif %}
            üë§ par 
            {% if benevole.user_modif %}
                {{ benevole.user_modif.split('@')[0] }}
            {% else %}
                inconnu
            {% endif %}
        </div>
    </div>

    <!-- üîπ Nom du b√©n√©vole + boutons navigation -->
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
        <div class="photo-hover-container" style="font-size: 1.4em; font-weight: bold; color: #333;">
            üßç {{ benevole_prenom }} {{ benevole_nom }}
            {% if photo_filename %}
            <div class="photo-popup">
                <img src="{{ url_for('static', filename='photos_benevoles/' ~ photo_filename) }}" alt="Photo">
            </div>
            {% endif %}
        </div>

        <div class="d-flex gap-2 flex-wrap justify-content-end">
            {% include "boutons_nav_benevole.html" %}
        </div>
    </div>

    <!-- üîπ Style du survol de photo -->
    <style>
    .photo-hover-container { position: relative; display: inline-block; cursor: pointer; }
    .photo-popup {
        display: none;
        position: absolute;
        top: -10px;
        left: 100%;
        z-index: 100;
        background: white;
        border: 1px solid #ccc;
        padding: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .photo-popup img {
        max-width: 240px;
        max-height: 240px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .photo-hover-container:hover .photo-popup { display: block; }
    </style>

    <!-- üîπ Messages Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="alert-container">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}


    <!-- üîπ Formulaire principal de mise √† jour -->
    <form id="updateForm" method="POST" enctype="multipart/form-data"
          action="{{ url_for('benevoles.update_benevole', benevole_id=benevole_id) }}?{{ next_url }}"
          class="partner-form">
        <input type="hidden" name="next_url" value="{{ next_url }}">
        <input type="hidden" name="go_to" id="go_to">
        <input type="hidden" name="do_upload" id="do_upload" value="1">

        {% set ordre_groupes = ['coordonn√©es principales', 'fonction', 'vie association'] %}

        {% for group_name in ordre_groupes %}
            {% if grouped_fields[group_name] is defined %}
            {% set fields = grouped_fields[group_name] %}
            <fieldset class="mb-3">
                <legend class="group-title d-flex justify-content-between align-items-center bg-light p-2 rounded" data-group-index="{{ loop.index0 }}">
                    {{ group_name }} <span class="toggle-icon">‚ñ∂</span>
                </legend>
                <div class="group-content p-3 border rounded bg-white" style="display: none;">
                    {% for field in fields %}
                    {% if field['field_name'] != 'id' %}
                    <div class="row mb-2">
                        <div class="col-md-4 fw-bold text-end">
                            {{ field['field_name'] | format_label }}
                            {% if field['required'] %}
                                <span class="text-danger">*</span>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            {% if field['field_name'] == 'type_benevole' or field['type_champ'] == 'liste_type_benevole' %}
                            {% set current = (field['value'] or '')|lower %}
                            <select name="{{ field['field_name'] }}" id="{{ field['field_name'] }}"
                                    class="form-select {% if champs_invalides and field['field_name'] in champs_invalides %}is-invalid{% endif %}"
                                    {% if lecture_seule %}disabled{% endif %}>
                                <option value="">-- Choisir --</option>
                                {% for val in type_benevole_options %}
                                <option value="{{ val }}" {{ 'selected' if current == (val|lower) else '' }}>
                                    {{ val|capitalize }}
                                </option>
                                {% endfor %}
                            </select>

                            {% elif field['type_champ'] == 'oui_non' %}
                            <select name="{{ field['field_name'] }}" id="{{ field['field_name'] }}" 
                                    class="form-control {% if champs_invalides and field['field_name'] in champs_invalides %}is-invalid{% endif %}"
                                    {% if lecture_seule %}disabled{% endif %}>
                                <option value="">-- Choisir --</option>
                                <option value="oui" {% if (field['value'] or '')|lower == 'oui' %}selected{% endif %}>Oui</option>
                                <option value="non" {% if (field['value'] or '')|lower == 'non' %}selected{% endif %}>Non</option>
                            </select>

                            {% else %}
                            <input type="text" id="{{ field['field_name'] }}" name="{{ field['field_name'] }}"
                                   {% set v = field['value'] if field['value'] is not none and field['value'] != 'None' else '' %}
                                   value="{% if field['type_champ'] == 'tel' %}{{ v | format_tel }}{% else %}{{ v }}{% endif %}"
                                   class="form-control {% if champs_invalides and field['field_name'] in champs_invalides %}is-invalid{% endif %}"
                                   {% if lecture_seule %}readonly{% endif %}>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </fieldset>
            {% endif %}
        {% endfor %}
    </form>


{% if not lecture_seule %}
<hr class="my-4">
<h5>üì∏ Photo du b√©n√©vole (voir dans le drive partag√© BA380 - TROMBINOSCOPE)</h5>

<!-- üü¢ Formulaire d'import / mise √† jour -->
<form method="POST" enctype="multipart/form-data"
      action="{{ url_for('benevoles.upload_photo_benevole', benevole_id=benevole_id) }}"
      class="border rounded p-3 bg-light mb-3">
  <div class="row align-items-center">
    <div class="col-md-6">
      <input type="file" name="photo" id="photo"
             accept="image/*" capture="environment" class="form-control mb-2">
      <button type="submit" class="btn btn-primary">Importer / Mettre √† jour</button>
    </div>
    <div class="col-md-6 text-center">
      {% if photo_filename %}
        <img src="{{ url_for('static', filename='photos_benevoles/' ~ photo_filename) }}"
             alt="Photo b√©n√©vole"
             class="img-thumbnail shadow-sm"
             style="max-width: 180px; border-radius: 10px;">
        <div class="text-muted small mt-1">Fichier : {{ photo_filename }}</div>
      {% else %}
        <div class="text-muted small fst-italic">Aucune photo enregistr√©e</div>
      {% endif %}
    </div>
  </div>
</form>

<!-- üî¥ Ligne d‚Äôactions : suppression photo + suppression b√©n√©vole -->
<div class="d-flex justify-content-end align-items-center gap-2 mb-4">

  {% if photo_filename %}
  <form method="POST"
        action="{{ url_for('benevoles.supprimer_photo_benevole', benevole_id=benevole_id) }}"
        onsubmit="return confirmDeletePhoto();" class="m-0">
      <button type="submit" class="btn btn-outline-danger">üóëÔ∏è Supprimer la photo</button>
  </form>
  {% endif %}

  <form method="POST"
        action="{{ url_for('benevoles.delete_benevole', benevole_id=benevole_id) }}"
        onsubmit="return confirmDelete();" class="m-0">
      <input type="hidden" name="confirm_final" id="confirm_final">
      <button type="submit" class="btn btn-danger">üóëÔ∏è Supprimer le b√©n√©vole</button>
  </form>

</div>
{% endif %}

<!-- üîπ Scripts de gestion de formulaire -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const localStorageKey = "update_benevole_open_index";
    const groupTitles = document.querySelectorAll(".group-title");

    groupTitles.forEach((title, index) => {
        const content = title.nextElementSibling;
        const icon = title.querySelector(".toggle-icon");
        if (localStorage.getItem(localStorageKey) == index) {
            content.style.display = "block";
            icon.textContent = "‚ñº";
        }
        title.addEventListener("click", function () {
            const isVisible = content.style.display === "block";
            groupTitles.forEach((otherTitle) => {
                const otherContent = otherTitle.nextElementSibling;
                const otherIcon = otherTitle.querySelector(".toggle-icon");
                otherContent.style.display = "none";
                if (otherIcon) otherIcon.textContent = "‚ñ∂";
            });
            if (!isVisible) {
                content.style.display = "block";
                icon.textContent = "‚ñº";
                localStorage.setItem(localStorageKey, index);
            } else {
                localStorage.removeItem(localStorageKey);
            }
        });
    });

    document.querySelectorAll("#updateForm input, #updateForm select, #updateForm textarea").forEach(input => {
        input.addEventListener("change", () => {
            formModified = true;
        });
    });
});

let formModified = false;

function confirmDeletePhoto() {
    return confirm("üóëÔ∏è Supprimer d√©finitivement la photo de ce b√©n√©vole ?");
}

function confirmDelete() {
    if (confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer ce b√©n√©vole ?")) {
        const confirmation = prompt("Tapez 'supprimer' pour confirmer la suppression d√©finitive :");
        if (confirmation === 'supprimer') {
            document.getElementById('confirm_final').value = 'supprimer';
            return true;
        } else {
            alert("‚ùå Confirmation incorrecte. Suppression annul√©e.");
            return false;
        }
    }
    return false;
}
function handleSave() {
    if (!formModified) {
        alert("Aucune modification d√©tect√©e.");
        return;
    }
    if (confirm("Souhaitez-vous enregistrer les modifications ?")) {
        document.getElementById("go_to").value = "";
        document.getElementById("do_upload").value = "1";
        document.getElementById("updateForm").submit();
    }
}

function handleNav(targetUrl) {
    if (!formModified) {
        window.location.href = targetUrl;
        return;
    }
    if (confirm("‚ö†Ô∏è Vous avez modifi√© le formulaire.\nSouhaitez-vous enregistrer vos modifications avant de continuer ?")) {
        document.getElementById("go_to").value = targetUrl;
        document.getElementById("do_upload").value = "0";
        document.getElementById("updateForm").submit();
    } else if (confirm("‚ùó Les modifications non enregistr√©es seront perdues.\nVoulez-vous vraiment continuer sans enregistrer ?")) {
        window.location.href = targetUrl;
    }
}

function handleReturn(targetUrl) {
    if (formModified) {
        if (confirm("‚ö†Ô∏è Vous avez modifi√© ce b√©n√©vole.\nSouhaitez-vous enregistrer les modifications avant de revenir √† la liste ?")) {
            document.getElementById("go_to").value = targetUrl;
            document.getElementById("do_upload").value = "1";
            document.getElementById("updateForm").submit();
        } else {
            window.location.href = targetUrl;
        }
    } else {
        window.location.href = targetUrl;
    }
}
</script>
{% endblock %}
