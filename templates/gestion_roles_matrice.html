{% extends "base.html" %}
{% block title %}Droits utilisateur{% endblock %}

{% block content %}
<h2>ğŸ” Droits de lâ€™utilisateur</h2>


<!-- ========================================================= -->
<!-- INFORMATIONS UTILISATEUR -->
<!-- ========================================================= -->
<div class="mb-3">
    <strong>Email :</strong> {{ user.email }}<br>
    <strong>Nom :</strong> {{ user.username or "-" }}
</div>

<form method="post">

    <!-- ========================================================= -->
    <!-- ADMINISTRATEUR GLOBAL -->
    <!-- ========================================================= -->
    <div class="form-check form-switch mb-4">
        <input
            class="form-check-input"
            type="checkbox"
            name="admin_global"
            id="admin_global"
            {% if user.role == 'admin' %}checked{% endif %}
        >
        <label class="form-check-label fw-bold" for="admin_global">
            Administrateur global
        </label>
    </div>

    <div id="admin-global-warning" class="alert alert-info" style="display:none;">
        ğŸ”’ Administrateur global : tous les droits sont accordÃ©s automatiquement.
        La matrice ci-dessous est dÃ©sactivÃ©e.
    </div>

    <!-- ========================================================= -->
    <!-- MATRICE DES DROITS MÃ‰TIERS -->
    <!-- Source de vÃ©ritÃ© : table roles_utilisateurs -->
    <!-- ========================================================= -->
    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Application</th>
                <th class="text-center">Aucun</th>
                <th class="text-center">Lecture</th>
                <th class="text-center">Ã‰criture</th>
                <th class="text-center">Admin</th>
            </tr>
        </thead>
        <tbody>

            {# 
                applications : dict { cle_appli: label_affichÃ© }
                roles        : dict { cle_appli: droit }
            #}

            {% for appli, label in applications.items() %}
            {% set droit = roles.get(appli, "aucun") %}
            <tr>
                <td class="fw-bold">{{ label }}</td>

                <!-- ===== AUCUN ===== -->
                <td class="text-center">
                    <input
                        type="radio"
                        name="droit_{{ appli }}"
                        value="aucun"
                        {% if droit == "aucun" %}checked{% endif %}
                    >
                </td>

                <!-- ===== LECTURE ===== -->
                <td class="text-center">
                    <input
                        type="radio"
                        name="droit_{{ appli }}"
                        value="lecture"
                        {% if droit == "lecture" %}checked{% endif %}
                    >
                </td>

                <!-- ===== Ã‰CRITURE ===== -->
                <td class="text-center">
                    <input
                        type="radio"
                        name="droit_{{ appli }}"
                        value="ecriture"
                        {% if droit == "ecriture" %}checked{% endif %}
                    >
                </td>

                <!-- ===== ADMIN ===== -->
                <td class="text-center">
                    <input
                        type="radio"
                        name="droit_{{ appli }}"
                        value="admin"
                        {% if droit == "admin" %}checked{% endif %}
                    >
                </td>
            </tr>
            {% endfor %}

        </tbody>
    </table>

    <!-- ========================================================= -->
    <!-- ACTIONS -->
    <!-- ========================================================= -->
    <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">
            ğŸ’¾ Enregistrer
        </button>
        <a href="{{ url_for('admin.gestion_utilisateurs') }}" class="btn btn-secondary">
            â¬…ï¸ Retour
        </a>
    </div>
</form>

<!-- ========================================================= -->
<!-- JS : dÃ©sactivation de la matrice si ADMIN GLOBAL -->
<!-- ========================================================= -->
<script>
function toggleMatrice() {
    const isAdmin = document.getElementById("admin_global").checked;

    document.getElementById("admin-global-warning").style.display =
        isAdmin ? "block" : "none";

    document
        .querySelectorAll("table input[type=radio]")
        .forEach(el => {
            el.disabled = isAdmin;
        });
}

document.getElementById("admin_global").addEventListener("change", toggleMatrice);
document.addEventListener("DOMContentLoaded", toggleMatrice);
</script>

{% endblock %}
