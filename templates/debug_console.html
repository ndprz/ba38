{% extends base_template %}

{% block title %}Console de Debug{% endblock %}

{% block content %}
<h2>ğŸªµ Console de Debug</h2>

<!-- ğŸ”€ Formulaire de sÃ©lection du fichier log Ã  afficher -->
<form method="POST" class="form-inline mb-3">
  <label for="log_file" class="mr-2">Fichier Ã  afficher :</label>
  <select name="log_file" id="log_file" class="form-control mr-2">
    {% for name, path in log_files.items() %}
      <option value="{{ name }}" {% if name == selected_log %}selected{% endif %}>{{ name }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-primary btn-sm mr-2">Afficher</button>
</form>

<!-- ğŸ§° Boutons contextuels selon le fichier sÃ©lectionnÃ© -->
<div class="mb-3">
  {% if selected_log == 'app.log' and is_admin_global() %}
    <a href="{{ url_for('debug_bp.export_logs') }}" class="btn btn-success btn-sm mr-2">ğŸ“¥ Exporter</a>
    <form method="POST" action="{{ url_for('debug_bp.clear_logs') }}" class="d-inline">
      <button type="submit" class="btn btn-danger btn-sm"
              onclick="return confirm('Effacer le fichier app.log ?');">
        ğŸ§¹ Effacer app.log
      </button>
    </form>
  {% elif selected_log == 'error.log (PA)' and is_admin_global() %}
    <form method="POST" action="{{ url_for('debug_bp.clear_error_log') }}" class="d-inline mr-2">
      <button type="submit" class="btn btn-danger btn-sm"
              onclick="return confirm('Effacer le fichier error.log ?');">
        ğŸ§¹ Effacer error.log (PA)
      </button>
    </form>
  {% endif %}

  {% if selected_log == 'error.log (PA)' and is_admin_global() %}
    <form method="POST" action="{{ url_for('debug_bp.trigger_error_log') }}" class="d-inline">
      <button type="submit" class="btn btn-warning btn-sm">ğŸ”Š Echo vers error.log</button>
    </form>
  {% endif %}


<!-- ğŸ“„ Affichage du contenu du log sÃ©lectionnÃ© (app.log ou autre) -->
{% if output %}
<div id="log-content" class="alert alert-{{ 'danger' if error else 'light' }}"
     style="max-height: 300px; overflow-y: auto;">
  <pre style="white-space: pre-wrap; font-size: 0.9rem;">{{ output }}</pre>
</div>
{% endif %}

<!-- ğŸ“¡ Section dÃ©diÃ©e Ã  error.log (PA), toujours visible -->
<h4>ğŸ“¡ Logs PythonAnywhere (error.log)</h4>
<button id="refresh-error-log" class="btn btn-outline-primary btn-sm">ğŸ” RafraÃ®chir</button>
<pre id="pa-log" style="max-height: 400px; overflow-y: auto; background: #000; color: #0f0; padding: 10px;">Chargement...</pre>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("âœ… DOM prÃªt");
  
    // Fonction appelÃ©e au clic ou initialement
    function refreshErrorLog() {
      console.log("â†’ Appel refreshErrorLog()");
      fetch('/get_error_log_tail')
        .then(response => {
          console.log("â†’ ReÃ§u : " + response.status);
          return response.text();
        })
        .then(data => {
          console.log("â†’ Contenu log (aperÃ§u) :", data.slice(0, 100));
          document.getElementById('pa-log').textContent = data;
        })
        .catch(err => {
          console.log("âŒ Erreur JS :", err);
          document.getElementById('pa-log').textContent = "âŒ Erreur : " + err;
        });
    }
  
    const btn = document.getElementById("refresh-error-log");
    if (btn) {
      console.log("âœ… Bouton trouvÃ©, liaison click...");
      btn.addEventListener("click", refreshErrorLog);
    } else {
      console.log("âŒ Bouton introuvable !");
    }
  
    refreshErrorLog();  // Appel initial dÃ¨s le chargement
  });

  
</script>

{% endblock %}
